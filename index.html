<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario CEDIS — Curvas en tiempo real</title>

  <!-- Tailwind (UI rápida) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js + adapter de fechas (escala X temporal REAL) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script>

  <style>
    .card{ box-shadow:0 6px 24px rgba(0,0,0,.08), 0 2px 6px rgba(0,0,0,.04); }
    #suggestions li{ cursor:pointer }
  </style>
</head>
<body class="bg-white text-slate-800 min-h-screen">
  <!-- HEADER -->
  <header class="bg-sky-600 text-white">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3 select-none">
        <!-- Logo seguro (SVG inline liviano, no rompe rutas) -->
        <svg class="h-10 sm:h-12 md:h-16 w-auto" viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
              <stop offset="0" stop-color="#38bdf8"/>
              <stop offset="1" stop-color="#0ea5e9"/>
            </linearGradient>
          </defs>
          <rect rx="12" ry="12" x="2" y="2" width="60" height="60" fill="url(#g)"/>
          <path d="M18 40c8-10 20-10 28 0" stroke="#fff" stroke-width="4" fill="none" stroke-linecap="round"/>
          <circle cx="32" cy="28" r="6" fill="#fff" opacity=".9"/>
        </svg>
        <h1 class="text-lg sm:text-2xl font-semibold">CEDIS Panamá – Curvas de Inventario</h1>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- BUSCADOR -->
    <section class="card bg-white rounded-2xl p-4">
      <div class="flex flex-col gap-3">
        <label class="text-sm text-slate-500">
          Busca por <b>código</b> o <b>nombre de suministro</b>
        </label>

        <div class="relative">
          <input id="q" type="search" placeholder="Ej.: 101098001 o amlodipina"
            class="w-full rounded-xl border border-slate-300 px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-sky-500">
          <button id="btnClearInput"
            class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 text-xl hidden"
            aria-label="Limpiar">×</button>
          <ul id="suggestions"
              class="absolute z-10 mt-1 w-full bg-white border border-slate-200 rounded-xl max-h-64 overflow-auto hidden">
          </ul>
        </div>

        <div class="flex gap-2">
          <button id="btnBuscar" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-xl">Buscar</button>
          <button id="btnLimpiar" class="bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-xl">Limpiar</button>
        </div>
      </div>
    </section>

    <!-- PANEL DATOS + GRÁFICO -->
    <section class="grid md:grid-cols-3 gap-4">
      <!-- DETALLE -->
      <div class="card bg-white rounded-2xl p-4 md:col-span-1 space-y-3">
        <h2 class="font-semibold text-slate-700">Detalle</h2>
        <div class="text-sm space-y-1">
          <div><span class="text-slate-500">Código:</span> <span id="lblCodigo" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Suministro:</span> <span id="lblSuministro">—</span></div>
          <div><span class="text-slate-500">KB_min:</span> <span id="lblKBmin" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Crítico:</span> <span id="lblCritico" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Promedio 30 días:</span> <span id="lblProm30" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Último inventario:</span> <span id="lblUltInv" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Fecha último:</span> <span id="lblUltFec" class="font-mono">—</span></div>
          <div class="text-xs text-slate-500 pt-2">Fuente: API Inventario CEDIS (Apps Script)</div>
        </div>
      </div>

      <!-- GRÁFICO -->
      <div class="card bg-white rounded-2xl p-4 md:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h2 id="ttlChart" class="font-semibold text-slate-700">Curva de Inventario</h2>
          <div class="text-xs text-slate-500" id="lblActualizado">—</div>
        </div>
        <div class="h-[360px]">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </section>
  </main>

  <footer class="py-8 text-center text-xs text-slate-400">
    v1.0 (sin PWA) • Rendimiento optimizado
  </footer>

  <!-- ======== APP SCRIPT ======== -->
  <script>
  /* ========= CONFIG ========= */
  // Usa el mismo endpoint que ya tenías funcionando (Apps Script)
  const API_BASE = 'https://script.google.com/macros/s/AKfycbxQsD4XJICmZg-5eiZIAEjJ3GZz-GmqvhvMWtiznEOu7SafIKxWopo5iIVy7ufrq_qq/exec';

  /* ========= Helpers/Refs ========= */
  const $  = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const nf = new Intl.NumberFormat('es-PA');

  const q = $('#q'), btnBuscar = $('#btnBuscar'), btnLimpiar = $('#btnLimpiar');
  const btnClearInput = $('#btnClearInput'), suggestions = $('#suggestions');

  const lblCodigo = $('#lblCodigo'), lblSuministro = $('#lblSuministro'), lblKBmin = $('#lblKBmin');
  const lblCritico = $('#lblCritico'), lblUltInv = $('#lblUltInv'), lblUltFec = $('#lblUltFec');
  const lblProm30 = $('#lblProm30'), lblAct = $('#lblActualizado'), ttlChartEl = $('#ttlChart');

  let searchCtrl = null, itemCtrl = null, chart = null;

  /* ========= UX input ========= */
  q.addEventListener('input', ()=>{
    btnClearInput.classList.toggle('hidden', q.value.trim()==='');
  });
  btnClearInput.addEventListener('click', ()=>{
    q.value=''; btnClearInput.classList.add('hidden'); hideSuggestions();
  });
  q.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){ hideSuggestions(); launchSearch(); }
  });
  btnBuscar.addEventListener('click', launchSearch);
  btnLimpiar.addEventListener('click', ()=>{
    q.value=''; btnClearInput.classList.add('hidden'); hideSuggestions(); renderItem(null);
  });

  /* ========= Sugerencias (rápidas) ========= */
  let tDeb = null;
  q.addEventListener('input', ()=>{
    clearTimeout(tDeb);
    const term = q.value.trim();
    if(term.length<2){ hideSuggestions(); return; }
    tDeb = setTimeout(()=>doSearch(term), 250);
  });

  function showSuggestions(items){
    if(!items?.length){ hideSuggestions(); return; }
    items = items.slice(0,10);
    suggestions.innerHTML = items.map(it=>`
      <li class="px-3 py-2 hover:bg-slate-100 border-b border-slate-100" data-cod="${it.codigo||''}">
        <div class="font-medium truncate">${it.suministro||''}</div>
        <div class="text-xs text-slate-500">${it.codigo||''}</div>
      </li>`).join('');
    suggestions.classList.remove('hidden');
    $$('#suggestions li').forEach(li=>{
      li.addEventListener('click', ()=>{
        const code = li.getAttribute('data-cod');
        q.value = code || ''; hideSuggestions(); if(code) fetchItem(code);
      });
    });
  }
  function hideSuggestions(){ suggestions.classList.add('hidden'); suggestions.innerHTML=''; }

  async function doSearch(term){
    try{
      if(searchCtrl) searchCtrl.abort();
      searchCtrl = new AbortController();
      const url = new URL(API_BASE);
      url.searchParams.set('action','search');
      url.searchParams.set('q', term);
      const res = await fetch(url, {signal:searchCtrl.signal, cache:'no-store'});
      const data = await res.json();
      showSuggestions(data.items||[]);
    }catch(e){ if(e.name!=='AbortError') console.error('search',e); }
  }

  function launchSearch(){
    const term = q.value.trim();
    if(!term) return;
    if(/^\d{6,}$/.test(term)) fetchItem(term);
    else doSearch(term);
  }

  /* ========= Cache + carga optimista ========= */
  async function fetchItem(code){
    try{
      setLoading(true);

      const cacheKey = 'item:'+code;
      const cached = localStorage.getItem(cacheKey);
      if(cached){
        // Render optimista inmediato
        renderItem(JSON.parse(cached), true);
      }

      if(itemCtrl) itemCtrl.abort();
      itemCtrl = new AbortController();
      const url = new URL(API_BASE);
      url.searchParams.set('action','item');
      url.searchParams.set('code', code);
      const res = await fetch(url, {signal:itemCtrl.signal, cache:'no-store'});
      const data = await res.json();

      // Si falta suministro, intenta inferir por search (1 salto, sin bloquear)
      if(!data.suministro){
        try{
          if(searchCtrl) searchCtrl.abort();
          searchCtrl = new AbortController();
          const su = new URL(API_BASE);
          su.searchParams.set('action','search'); su.searchParams.set('q', code);
          const sRes = await fetch(su,{signal:searchCtrl.signal, cache:'no-store'});
          const sData = await sRes.json();
          const hit = (sData.items||[]).find(it=>String(it.codigo||'')===String(code));
          if(hit?.suministro) data.suministro = hit.suministro;
        }catch(_){}
      }

      localStorage.setItem(cacheKey, JSON.stringify(data));
      renderItem(data);
    }catch(e){
      if(e.name!=='AbortError'){
        console.error('item',e);
        alert('No se pudo obtener el detalle. Verifica conexión o código.');
      }
    }finally{ setLoading(false); }
  }

  function setLoading(b){
    btnBuscar.disabled = b;
    btnBuscar.textContent = b? 'Buscando…' : 'Buscar';
  }

  /* ========= Utilitarios de datos ========= */
  // Normaliza fecha a ISO (local -> 00:00) y devuelve Date real para escala temporal
  function normalizeDate(dStr){
    // Admite "YYYY-MM-DD", "DD/MM/YYYY" o "YYYY/MM/DD"
    if(!dStr) return null;
    const s = String(dStr).trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00');
    if(/^\d{4}\/\d{2}\/\d{2}$/.test(s)) return new Date(s.replace(/\//g,'-')+'T00:00:00');
    const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); // dd/mm/yyyy
    if(m){
      const [_,dd,mm,yyyy]=m;
      return new Date(`${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T00:00:00`);
    }
    const dt = new Date(s);
    return isNaN(dt)? null : dt;
  }

  // Agrupa por día sumando inventario
  function groupByDateSum(points){
    const map = new Map();
    for(const p of (points||[])){
      const d = normalizeDate(p.fecha);
      if(!d) continue;
      const key = d.toISOString().slice(0,10); // YYYY-MM-DD
      const inv = Number(p.inventario||0);
      map.set(key, (map.get(key)||0)+inv);
    }
    const arr = [...map.entries()]
      .sort((a,b)=> a[0]<b[0]? -1 : 1)
      .map(([iso, inv]) => ({ x: new Date(iso+'T00:00:00'), y: inv }));
    return arr;
  }

  // SMA 30 días sobre datos {x:Date,y:number}
  function sma30XY(data){
    const out = [];
    for(let i=0;i<data.length;i++){
      const to = data[i].x.getTime();
      const from = to - 29*86400000;
      let sum=0,cnt=0;
      for(let k=i;k>=0;k--){
        const t = data[k].x.getTime();
        if(t<from) break;
        sum += Number(data[k].y||0); cnt++;
      }
      out.push({ x: data[i].x, y: cnt? (sum/cnt) : null });
    }
    return out;
  }

  /* ========= Render ========= */
  function renderItem(data, fromCache=false){
    // Reset si no hay data
    if(!data){
      lblCodigo.textContent='—'; lblSuministro.textContent='—';
      lblKBmin.textContent='—'; lblCritico.textContent='—';
      lblUltInv.textContent='—'; lblUltFec.textContent='—'; lblProm30.textContent='—';
      lblAct.textContent='—'; ttlChartEl.textContent='Curva de Inventario';
      if(chart) chart.destroy();
      return;
    }

    // Consolidar serie diaria
    const puntosRaw = Array.isArray(data.puntos)? data.puntos : [];
    const serie = groupByDateSum(puntosRaw); // [{x:Date,y:number},...]
    const sma30 = sma30XY(serie);
    const last = serie[serie.length-1];

    // Panel
    lblCodigo.textContent     = data.codigo || '—';
    lblSuministro.textContent = data.suministro || '—';
    lblKBmin.textContent      = (data.kb_min!=null? nf.format(+data.kb_min) : '—');
    lblCritico.textContent    = (data.critico!=null? nf.format(+data.critico) : '—');
    lblUltInv.textContent     = last? nf.format(+last.y) : '—';
    lblUltFec.textContent     = last? last.x.toISOString().slice(0,10) : '—';
    lblProm30.textContent     = (sma30.length && sma30[sma30.length-1].y!=null)? nf.format(+sma30[sma30.length-1].y) : '—';
    lblAct.textContent        = (fromCache? '(caché) ' : '') + new Date().toLocaleString();
    ttlChartEl.textContent    = `${data.codigo||'—'} — ${data.suministro||'—'}`;

    // Datasets
    const ds = [
      {
        label:'Inventario',
        data: serie,            // {x:Date,y:number}
        parsing: false,         // ya viene en {x,y}
        borderWidth: 2,
        borderColor: 'rgba(59,130,246,1)',
        backgroundColor:'rgba(59,130,246,0.15)',
        pointRadius: 0,
        hoverRadius: 3,
        tension: .2,
        fill: 'origin'
      },
      {
        label:'Promedio 30 días',
        data: sma30,
        parsing: false,
        borderWidth: 2,
        borderDash: [6,4],
        borderColor:'rgba(100,116,139,1)',
        backgroundColor:'rgba(100,116,139,0.08)',
        pointRadius: 0,
        hoverRadius: 0,
        tension: .2,
        fill:false
      }
    ];

    if(Number.isFinite(+data.kb_min)){
      ds.push({
        label:'KB_min',
        data: serie.map(p=>({x:p.x, y:+data.kb_min})),
        parsing:false,
        borderColor:'rgba(234,179,8,1)',
        backgroundColor:'rgba(234,179,8,0.08)',
        pointRadius:0, borderWidth:1, fill:false
      });
    }
    if(Number.isFinite(+data.critico)){
      ds.push({
        label:'Crítico',
        data: serie.map(p=>({x:p.x, y:+data.critico})),
        parsing:false,
        borderColor:'rgba(239,68,68,1)',
        backgroundColor:'rgba(239,68,68,0.08)',
        pointRadius:0, borderWidth:1, fill:false
      });
    }

    // Plugin: último valor a la derecha
    const lastValuePlugin = {
      id:'lastValuePlugin',
      afterDatasetsDraw(c, args){
        const {ctx, data} = c; ctx.save();
        ctx.font = '12px sans-serif'; ctx.textBaseline='middle';
        data.datasets.forEach((dSet, idx)=>{
          const meta = c.getDatasetMeta(idx);
          if(!meta?.data?.length) return;
          // busca último punto con y numérico
          let j = dSet.data.length-1;
          while(j>=0 && (dSet.data[j]==null || !isFinite(dSet.data[j].y))) j--;
          if(j<0) return;
          const elem = meta.data[j]; if(!elem) return;
          const val = dSet.data[j].y; if(!isFinite(val)) return;
          const x = elem.x + 6, y = elem.y;
          ctx.fillStyle = Array.isArray(dSet.borderColor)? dSet.borderColor[0] : (dSet.borderColor||'#334155');
          ctx.fillText(nf.format(val), x, y);
        });
        ctx.restore();
      }
    };

    // Render Chart
    if(chart) chart.destroy();
    const ctx = document.getElementById('chart').getContext('2d');
    chart = new Chart(ctx, {
      type:'line',
      data:{ datasets: ds },
      options:{
        responsive:true, maintainAspectRatio:false,
        animation:false,                      // sin animación = más veloz
        interaction:{intersect:false, mode:'index'},
        layout:{ padding:{ right:64 } },
        plugins:{
          legend:{ position:'top' },
          tooltip:{
            callbacks:{
              title(items){
                if(!items?.length) return '';
                const x = items[0].raw?.x;
                return x? new Date(x).toISOString().slice(0,10) : '';
              },
              label(ctx){ return `${ctx.dataset.label}: ${nf.format(ctx.raw.y)}`; }
            }
          }
        },
        scales:{
          x:{
            type:'time',
            time:{ unit:'day', tooltipFormat:'yyyy-MM-dd', displayFormats:{day:'yyyy-MM-dd'} },
            ticks:{ source:'data', autoSkip:true, maxRotation:0, minRotation:0 },
            grid:{ display:false }
          },
          y:{
            beginAtZero:false,
            grid:{ color:'rgba(148,163,184,0.15)' }
          }
        }
      },
      plugins:[lastValuePlugin]
    });
  }
  </script>
</body>
</html>
