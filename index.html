<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Curvas de Inventario</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style> body{font-family:system-ui, sans-serif; margin:16px;} .row{display:flex; gap:16px; flex-wrap:wrap;} .card{flex:1 1 380px; border:1px solid #ddd; border-radius:12px; padding:16px;} label{display:block; margin-bottom:6px;} input,select{width:100%; padding:8px; margin-bottom:8px;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #eee; padding:6px; font-size:12px;} </style>
</head>
<body>
<h1>Curvas de Inventario — CEDIS Panamá</h1>
<div class="row">
  <div class="card">
    <label for="mode">Buscar por</label>
    <select id="mode"><option>Código</option><option>Suministro</option></select>
    <label id="lbl-term" for="term">Código</label>
    <select id="term"></select>
    <label for="qty">Cantidad a solicitar (entrega en 45 días)</label>
    <input id="qty" type="number" min="0" step="100" value="0" />
    <button id="btn">Actualizar</button>
    <p id="meta"></p>
  </div>
  <div class="card"><canvas id="chart" height="300"></canvas></div>
</div>
<div class="card">
  <h3>Tabla diaria</h3>
  <table id="tbl"><thead><tr><th>Fecha</th><th>Inventario</th><th>Inv. Crítico</th><th>KB_min</th></tr></thead><tbody></tbody></table>
</div>
<script>
const API_BASE = 'https://script.google.com/macros/s/AKfycbyvmMSLIwNNAZSr_CffgH_LGTw6xFPqZ4H2tjQdVZnlTP0_bgFgvasLqPTElBUHSPkdOA/exec'; // pega aquí la URL del Web App
const LEAD = 45; // debe coincidir con backend

let chart;
async function fetchList(){
  const r = await fetch(API_BASE + '?list=true');
  return r.json();
}
async function fetchSerieBy(mode, term){
  const url = mode==='Código' ? `${API_BASE}?codigo=${encodeURIComponent(term)}` : `${API_BASE}?suministro=${encodeURIComponent(term)}`;
  const r = await fetch(url);
  return r.json();
}
function ses(cons, H, alpha=0.3){
  if (!cons.length) return Array(H).fill(0);
  let s = cons[0];
  for (let i=1;i<cons.length;i++){ s = alpha*cons[i] + (1-alpha)*s; }
  return Array(H).fill(s);
}
function simulate(invLast, dHat, q=0, lead=LEAD){
  const H = dHat.length; const base = new Array(H); const withOrder = new Array(H);
  for (let h=0; h<H; h++){
    if (h===0) base[h] = Math.max(invLast - dHat[h], 0);
    else base[h] = Math.max(base[h-1] - dHat[h], 0);
  }
  // aplicar pedido en t+lead
  withOrder[0] = Math.max(invLast - dHat[0], 0);
  for (let h=1; h<H; h++){ withOrder[h] = Math.max(withOrder[h-1] - dHat[h], 0); }
  const idx = lead-1; if (idx>=0 && idx<H){ withOrder[idx] += Number(q||0);
    for (let h=idx+1, prev=withOrder[idx]; h<H; h++){ withOrder[h] = Math.max(withOrder[h-1] - dHat[h], 0); }
  }
  return {base, withOrder};
}
function updateTable(tbody, serie, kb, sfty){
  tbody.innerHTML='';
  for (const p of serie){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.fecha}</td><td>${Number(p.inventario).toLocaleString()}</td><td>${sfty.toFixed(2)}</td><td>${kb.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  }
}
async function init(){
  const modeSel = document.getElementById('mode');
  const termSel = document.getElementById('term');
  const lbl = document.getElementById('lbl-term');
  const qty = document.getElementById('qty');
  const btn = document.getElementById('btn');
  const tbody = document.querySelector('#tbl tbody');
  const meta = document.getElementById('meta');

  const list = await fetchList();
  const codes = [...new Set(list.map(x=>x.codigo))].sort();
  const sups  = [...new Set(list.map(x=>x.suministro))].sort();

  function fillTerms(){
    const isCode = modeSel.value==='Código';
    lbl.textContent = isCode ? 'Código' : 'Suministro';
    const arr = isCode ? codes : sups;
    termSel.innerHTML = arr.map(v=>`<option>${v}</option>`).join('');
  }

  modeSel.addEventListener('change', fillTerms);
  fillTerms();

  btn.addEventListener('click', async ()=>{
    const mode = modeSel.value; const term = termSel.value; const Q = Number(qty.value||0);
    const data = await fetchSerieBy(mode, term);
    if (data.error){ alert(data.error); return; }
    const serie = data.serie; // [{fecha, inventario}]
    if (!serie.length){ alert('Sin datos'); return; }

    // consumo y SES
    const inv = serie.map(p=>Number(p.inventario));
    const cons=[]; for(let i=1;i<inv.length;i++){ cons.push(Math.max(inv[i-1]-inv[i],0)); }
    const dHat = ses( cons, 45, 0.3 );

    const invLast = inv[inv.length-1];
    const {base, withOrder} = simulate(invLast, dHat, Q, data.lead||LEAD);

    const lastDate = new Date(serie[serie.length-1].fecha);
    const future = []; for(let i=1;i<=45;i++){ const d=new Date(lastDate); d.setDate(d.getDate()+i); future.push(d.toISOString().slice(0,10)); }

    const labels = serie.map(p=>p.fecha).concat(future);
    const invHist = inv;
    const proj = base;
    const projPlus = withOrder;

    const invAvg = inv.reduce((a,b)=>a+b,0)/inv.length;
    const kb = Number(data.kb_min||0);
    const sfty = Number(data.inventario_critico||0);

    updateTable(tbody, serie, kb, sfty);

    const ctx = document.getElementById('chart').getContext('2d');
    if (window.chart) window.chart.destroy();
    window.chart = new Chart(ctx, { type:'line', data:{
      labels,
      datasets:[
        {label:'Inventario histórico', data:invHist},
        {label:'Proyección 45 días', data:proj},
        {label:'Proyección + pedido', data:projPlus},
        {label:'KB_min (Punto de Reorden)', data:Array(labels.length).fill(kb)},
        {label:'Inventario Crítico', data:Array(labels.length).fill(sfty)},
        {label:'Inventario Promedio', data:Array(labels.length).fill(invAvg)}
      ]
    }, options:{ responsive:true, maintainAspectRatio:false }});

    meta.textContent = `KB_min: ${kb.toFixed(2)} | Inv. Crítico: ${sfty.toFixed(2)} | Promedio histórico: ${invAvg.toFixed(2)}`;
  });
}

window.addEventListener('load', ()=>{ init(); if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js'); });
</script>
</body>
</html>
