<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CEDIS Panama – Curvas de Inventario</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <!-- UI (Tailwind CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <style>
    .card{ box-shadow:0 6px 24px rgba(0,0,0,.08), 0 2px 6px rgba(0,0,0,.04); }
    #suggestions li{ cursor:pointer }
    .disabled{ opacity:.5; pointer-events:none }
  </style>
</head>
<body class="bg-white text-slate-800 min-h-screen">
  <!-- HEADER -->
  <header class="bg-sky-600 text-white">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <!-- LOGO (archivo del repo, ruta relativa) -->
        <img src="./icons/icon-192.png"
             alt="DINALOG - CSS Panamá"
             class="h-10 sm:h-12 md:h-16 w-auto mr-3 select-none"
             loading="eager" decoding="async"/>
        <h1 class="text-lg sm:text-2xl font-semibold">CEDIS Panama – Curvas de Inventario</h1>
      </div>
      <button id="btnInstall" class="hidden bg-white/10 hover:bg-white/20 px-3 py-1 rounded">Instalar</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- BUSCADOR -->
    <section class="card bg-white rounded-2xl p-4">
      <div class="flex flex-col gap-3">
        <label class="text-sm text-slate-500">
          Busca por <b>código</b> o <b>nombre de suministro</b>
        </label>

        <div class="relative">
          <input id="q" type="search" placeholder="Ej.: 101098001 o amlodipina"
                 class="w-full rounded-xl border border-slate-300 px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-sky-500">
          <button id="btnClearInput" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 text-xl hidden" aria-label="Limpiar">×</button>
          <ul id="suggestions" class="absolute z-10 mt-1 w-full bg-white border border-slate-200 rounded-xl max-h-64 overflow-auto hidden"></ul>
        </div>

        <div class="flex gap-2">
          <button id="btnBuscar" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-xl">Buscar</button>
          <button id="btnLimpiar" class="bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-xl">Limpiar</button>
        </div>
      </div>
    </section>

    <!-- PANEL DATOS + GRÁFICO -->
    <section class="grid md:grid-cols-3 gap-4">
      <!-- DETALLE -->
      <div class="card bg-white rounded-2xl p-4 md:col-span-1 space-y-3">
        <h2 class="font-semibold text-slate-700">Detalle</h2>
        <div class="text-sm space-y-1">
          <div><span class="text-slate-500">Código:</span> <span id="lblCodigo" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Suministro:</span> <span id="lblSuministro">—</span></div>
          <div><span class="text-slate-500">KB_min:</span> <span id="lblKBmin" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Crítico:</span> <span id="lblCritico" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Promedio 30 días:</span> <span id="lblProm30" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Último inventario:</span> <span id="lblUltInv" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Fecha último:</span> <span id="lblUltFec" class="font-mono">—</span></div>
          <div class="text-xs text-slate-500 pt-2">Fuente: API Inventario CEDIS (Apps Script)</div>
        </div>
      </div>

      <!-- GRÁFICO -->
      <div class="card bg-white rounded-2xl p-4 md:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h2 id="ttlChart" class="font-semibold text-slate-700">Curva de Inventario</h2>
          <div class="text-xs text-slate-500" id="lblActualizado">—</div>
        </div>
        <div class="h-[360px]">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </section>
  </main>

  <footer class="py-8 text-center text-xs text-slate-400">
    v1.2 • PWA • Actualiza en tiempo real
  </footer>

  <!-- ======== APP SCRIPT (igual que tu versión estable) ======== -->
  <script>
  /* ========= CONFIG ========= */
  const API_BASE = 'https://script.google.com/macros/s/AKfycbxQsD4XJICmZg-5eiZIAEjJ3GZz-GmqvhvMWtiznEOu7SafIKxWopo5iIVy7ufrq_qq/exec';

  /* ========= util de selección ========= */
  const el = s => document.querySelector(s);
  const els = s => Array.from(document.querySelectorAll(s));

  /* ========= refs ========= */
  const q = el('#q');
  const btnBuscar = el('#btnBuscar');
  const btnLimpiar = el('#btnLimpiar');
  const btnClearInput = el('#btnClearInput');
  const suggestions = el('#suggestions');

  const lblCodigo = el('#lblCodigo');
  const lblSuministro = el('#lblSuministro');
  const lblKBmin = el('#lblKBmin');
  const lblCritico = el('#lblCritico');
  const lblUltInv = el('#lblUltInv');
  const lblUltFec = el('#lblUltFec');
  const lblProm30 = el('#lblProm30');
  const lblAct = el('#lblActualizado');
  const ttlChartEl = el('#ttlChart');

  let chart, searchCtrl=null, itemCtrl=null, deferPrompt=null;
  const nf = new Intl.NumberFormat('en-US');

  /* ========= INPUT UX ========= */
  q.addEventListener('input', () => {
    btnClearInput.classList.toggle('hidden', q.value.trim()==='');
  });
  btnClearInput.addEventListener('click', () => {
    q.value=''; btnClearInput.classList.add('hidden'); hideSuggestions();
  });
  q.addEventListener('keydown', e => {
    if (e.key==='Enter') { hideSuggestions(); launchSearch(); }
  });
  btnBuscar.addEventListener('click', launchSearch);
  btnLimpiar.addEventListener('click', () => { q.value=''; btnClearInput.classList.add('hidden'); hideSuggestions(); renderItem(null); });

  /* ========= Sugerencias ========= */
  let deb;
  q.addEventListener('input', () => {
    clearTimeout(deb);
    const term = q.value.trim();
    if (term.length<2) { hideSuggestions(); return; }
    deb = setTimeout(()=>doSearch(term), 250);
  });
  function hideSuggestions(){ suggestions.classList.add('hidden'); suggestions.innerHTML=''; }
  function showSuggestions(items){
    if (!items?.length){ hideSuggestions(); return; }
    items = items.slice(0,10);
    suggestions.innerHTML = items.map(it => `
      <li class="px-3 py-2 hover:bg-slate-100 border-b border-slate-100" data-cod="${it.codigo}">
        <div class="font-medium">${it.suministro||''}</div>
        <div class="text-xs text-slate-500">${it.codigo||''}</div>
      </li>`).join('');
    suggestions.classList.remove('hidden');
    els('#suggestions li').forEach(li=>{
      li.addEventListener('click', ()=>{
        const cod = li.getAttribute('data-cod');
        q.value = cod; hideSuggestions(); fetchItem(cod);
      });
    });
  }
  async function doSearch(term){
    try{
      if (searchCtrl) searchCtrl.abort();
      searchCtrl = new AbortController();
      const url = new URL(API_BASE); url.searchParams.set('action','search'); url.searchParams.set('q', term);
      const res = await fetch(url, {cache:'no-store', signal:searchCtrl.signal});
      const data = await res.json();
      showSuggestions(data.items||[]);
    }catch(e){ if (e.name!=='AbortError') console.error(e); }
  }
  function launchSearch(){
    const term = q.value.trim(); if (!term) return;
    if (/^\d{6,}$/.test(term)) fetchItem(term); else doSearch(term);
  }

  /* ========= Item ========= */
  function setLoading(b){ btnBuscar.disabled=b; btnBuscar.textContent = b? 'Buscando…':'Buscar'; }

  function groupByDateSum(points){
    const b={}; for (const p of (points||[])){ const f=String(p.fecha||'').trim(); const inv=Number(p.inventario||0); if(!f) continue; b[f]=(b[f]||0)+inv; }
    // Normaliza formato dd/mm/yyyy -> yyyy-mm-dd para ordenar seguro
    const norm = s => {
      const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if (m){ const d=m[1].padStart(2,'0'), M=m[2].padStart(2,'0'), Y=(m[3].length===2?'20'+m[3]:m[3]); return `${Y}-${M}-${d}`; }
      return s; // ya viene ISO
    };
    return Object.keys(b).sort((a,b2)=> new Date(norm(a)) - new Date(norm(b2)))
      .map(f=>({fecha:f, inventario:b[f]}));
  }

  function sma30(labels, serie){
    const toDate = s=>{
      const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      return m? new Date((m[3].length===2?'20'+m[3]:m[3]), Number(m[2])-1, Number(m[1])) : new Date(s);
    };
    const dts = labels.map(toDate);
    return labels.map((_,i)=>{
      const to=dts[i], from=new Date(to); from.setDate(from.getDate()-29);
      let sum=0,cnt=0; for(let k=i;k>=0 && dts[k]>=from;k--){ sum += Number(serie[k]||0); cnt++; }
      return cnt? sum/cnt : null;
    });
  }

  async function fetchItem(code){
    try{
      setLoading(true);
      const cacheKey = 'item:'+code;
      const cached = localStorage.getItem(cacheKey);
      if (cached) renderItem(JSON.parse(cached), true);

      if (itemCtrl) itemCtrl.abort();
      itemCtrl = new AbortController();
      const url = new URL(API_BASE); url.searchParams.set('action','item'); url.searchParams.set('code', code);
      const res = await fetch(url, {cache:'no-store', signal:itemCtrl.signal});
      const data = await res.json();

      if (!data.suministro){
        try{
          if (searchCtrl) searchCtrl.abort();
          searchCtrl = new AbortController();
          const sUrl = new URL(API_BASE); sUrl.searchParams.set('action','search'); sUrl.searchParams.set('q', code);
          const sRes = await fetch(sUrl, {cache:'no-store', signal:searchCtrl.signal});
          const sData = await sRes.json();
          const hit = (sData.items||[]).find(it => (it.codigo||'') == String(code));
          if (hit?.suministro) data.suministro = hit.suministro;
        }catch(_){}
      }

      localStorage.setItem(cacheKey, JSON.stringify(data));
      renderItem(data);
    }catch(e){
      if (e.name!=='AbortError'){ console.error(e); alert('No se pudo obtener el detalle.'); }
    }finally{ setLoading(false); }
  }

  function renderItem(data, fromCache=false){
    if (!data){
      [lblCodigo,lblSuministro,lblKBmin,lblCritico,lblUltInv,lblUltFec,lblProm30,lblAct].forEach(n=>n.textContent='—');
      ttlChartEl.textContent='Curva de Inventario';
      if (chart) chart.destroy();
      return;
    }
    const puntos = groupByDateSum(Array.isArray(data.puntos)?data.puntos:[]);
    const labels = puntos.map(p=>p.fecha);
    const inv = puntos.map(p=>Number(p.inventario||0));
    const last = puntos[puntos.length-1];
    const avg30 = sma30(labels, inv); const lastAvg = avg30[avg30.length-1];

    lblCodigo.textContent = data.codigo||'—';
    lblSuministro.textContent = data.suministro||'—';
    lblKBmin.textContent = (data.kb_min!=null ? nf.format(+data.kb_min) : '—');
    lblCritico.textContent = (data.critico!=null ? nf.format(+data.critico) : '—');
    lblUltInv.textContent = last ? nf.format(Number(last.inventario||0)) : '—';
    lblUltFec.textContent = last ? last.fecha : '—';
    lblProm30.textContent = (lastAvg!=null ? nf.format(lastAvg) : '—');
    lblAct.textContent = (fromCache?'(caché) ':'') + new Date().toLocaleString();
    ttlChartEl.textContent = `${data.codigo || '—'} — ${data.suministro || '—'}`;

    const datasets = [
      {label:'Inventario', data:inv, borderColor:'rgba(59,130,246,1)', backgroundColor:'rgba(59,130,246,.15)', pointRadius:2, borderWidth:2, tension:.2, fill:'origin', clip:false},
      {label:'Promedio 30 días', data:avg30, borderColor:'rgba(100,116,139,1)', backgroundColor:'rgba(100,116,139,.08)', pointRadius:0, borderWidth:2, borderDash:[6,4], tension:.2, fill:false, clip:false}
    ];
    if (Number.isFinite(+data.kb_min)) datasets.push({label:'KB_min', data:labels.map(()=>+data.kb_min), borderColor:'rgba(234,179,8,1)', backgroundColor:'rgba(234,179,8,.10)', pointRadius:0, borderWidth:1, fill:false, clip:false});
    if (Number.isFinite(+data.critico)) datasets.push({label:'Crítico', data:labels.map(()=>+data.critico), borderColor:'rgba(239,68,68,1)', backgroundColor:'rgba(239,68,68,.10)', pointRadius:0, borderWidth:1, fill:false, clip:false});

    const lastValuePlugin = {
      id:'lastValuePlugin',
      afterDatasetsDraw(c){
        const {ctx} = c; ctx.save(); ctx.font='12px sans-serif'; ctx.textBaseline='middle';
        c.data.datasets.forEach((ds,i)=>{
          const meta=c.getDatasetMeta(i); if(!meta?.data?.length) return;
          let idx=ds.data.length-1; while(idx>=0 && (ds.data[idx]==null || !isFinite(ds.data[idx]))) idx--;
          if (idx<0) return; const pt=meta.data[idx]; const val=+ds.data[idx]; if(!pt || !isFinite(val)) return;
          ctx.fillStyle = Array.isArray(ds.borderColor)? ds.borderColor[0] : (ds.borderColor||'#334155');
          ctx.fillText(nf.format(val), pt.x+6, pt.y);
        });
        ctx.restore();
      }
    };

    function xTickCallback(value, index, ticks){
      const lbl = labels[index];
      // Muestra cada 14 días aprox y SIEMPRE el último
      const toKey = s=>{
        const m=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
        if (m){ const d=+m[1], M=+m[2], Y=+(m[3].length===2?'20'+m[3]:m[3]); return new Date(Y,M-1,d); }
        return new Date(s);
      };
      if (index === ticks.length-1) return lbl;
      const d0 = toKey(labels[0]); const di = toKey(lbl);
      const diff = Math.round((di-d0)/(1000*60*60*24));
      return (diff%14===0)? lbl : '';
    }

    if (chart) chart.destroy();
    chart = new Chart(document.getElementById('chart').getContext('2d'), {
      type:'line',
      data:{labels, datasets},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{intersect:false, mode:'index'},
        layout:{padding:{right:60}},
        plugins:{ legend:{position:'top'}, tooltip:{callbacks:{label(c){return `${c.dataset.label}: ${nf.format(c.parsed.y)}`;}}}},
        scales:{ x:{ticks:{autoSkip:false,maxRotation:0,minRotation:0,callback:xTickCallback}}, y:{beginAtZero:false} }
      },
      plugins:[lastValuePlugin]
    });
  }

  /* ========= PWA ========= */
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      // Ruta relativa para GitHub Pages (mismo directorio que index)
      navigator.serviceWorker.register('sw.js').catch(console.error);
    });
  }
  window.addEventListener('beforeinstallprompt', (e)=>{
    e.preventDefault(); deferPrompt=e;
    document.getElementById('btnInstall')?.classList.remove('hidden');
  });
  document.getElementById('btnInstall')?.addEventListener('click', async ()=>{
    if (!deferPrompt) return;
    deferPrompt.prompt(); await deferPrompt.userChoice;
    deferPrompt=null; document.getElementById('btnInstall')?.classList.add('hidden');
  });
  </script>
</body>
</html>
