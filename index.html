<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CEDIS Panamá – Curvas de Inventario</title>

  <!-- Manifest + Icons existentes en tu repo -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
  <link rel="apple-touch-icon" href="./icons/icon-192.png"/>

  <!-- Chart.js (CDN oficial) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --brand:#0ea5e9;
      --blue:#3b82f6; --blueA:rgba(59,130,246,.15);
      --gray:#64748b; --grayA:rgba(100,116,139,.08);
      --amber:#eab308; --amberA:rgba(234,179,8,.10);
      --red:#ef4444; --redA:rgba(239,68,68,.10);
      --shadow:0 10px 25px -15px rgba(2,6,23,.25);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
    }
    header{
      background:#0b74c1;color:#fff;box-shadow:var(--shadow);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .bar{
      display:flex;align-items:center;gap:14px; padding:12px 0;
    }
    .brand{display:flex;align-items:center;gap:12px;font-weight:700;font-size:20px}
    .brand img{height:38px;width:38px}
    .install{margin-left:auto;background:#1e90ff;border:0;color:#fff;padding:9px 14px;border-radius:10px;cursor:pointer}
    .box{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
    .search{padding:18px}
    .row{display:grid;grid-template-columns:1fr 2fr;gap:18px;padding:0 18px 18px}
    @media (max-width:900px){ .row{grid-template-columns:1fr} }
    .inputbar{display:flex;gap:10px;align-items:center}
    .inputbar input{
      flex:1;padding:14px;border-radius:12px;border:1px solid #cbd5e1;outline:none;
    }
    .btn{padding:12px 16px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;cursor:pointer}
    .btn.primary{background:#0ea5e9;color:#fff;border:none}
    .card{padding:18px}
    .title{font-weight:700;margin:2px 0 14px 0}
    .kv{line-height:1.85}
    .kv b{color:#0b4d86}
    .muted{color:var(--muted);font-size:12px}
    .chartWrap{height:440px;padding:12px}
    .chartHead{display:flex;justify-content:space-between;align-items:center;padding:12px 10px 0 10px}
    .foot{padding:14px;text-align:center;color:var(--muted);font-size:12px}
    .link{color:#0b74c1;text-decoration:none}
  </style>
</head>
<body>
  <header>
    <div class="wrap bar">
      <div class="brand">
        <img src="./icons/icon-192.png" alt="CSS Panamá">
        <div>CEDIS Panama – Curvas de Inventario</div>
      </div>
      <button id="btnInstall" class="install">Instalar</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Buscador -->
    <section class="box search">
      <label class="muted">Busca por <b>código</b> o <b>nombre de suministro</b></label>
      <div class="inputbar" style="margin-top:8px">
        <input id="q" placeholder="Ej.: 101098001 o amlodipina" autocomplete="off">
        <button class="btn primary" id="btnBuscar">Buscar</button>
        <button class="btn" id="btnLimpiar">Limpiar</button>
      </div>
    </section>

    <!-- Detalle + Chart -->
    <section class="row">
      <div class="box card">
        <div class="title">Detalle</div>
        <div class="kv"><b>Código:</b> <span id="lblCodigo">—</span></div>
        <div class="kv"><b>Suministro:</b> <span id="lblSuministro">—</span></div>
        <div class="kv"><b>KB_min:</b> <span id="lblKBmin">—</span></div>
        <div class="kv"><b>Crítico:</b> <span id="lblCritico">—</span></div>
        <div class="kv"><b>Promedio 30 días:</b> <span id="lblProm30">—</span></div>
        <div class="kv"><b>Último inventario:</b> <span id="lblUltInv">—</span></div>
        <div class="kv"><b>Fecha último:</b> <span id="lblUltFec">—</span></div>
        <p class="muted" style="margin-top:10px">Fuente: API Inventario CEDIS (Apps Script)</p>
      </div>

      <div class="box">
        <div class="chartHead">
          <div class="title" id="ttlChart">Curva de Inventario</div>
          <div class="muted" id="lblActualizado"></div>
        </div>
        <div class="chartWrap"><canvas id="chart"></canvas></div>
      </div>
    </section>

    <div class="foot">v1.2 • PWA • Actualiza en tiempo real</div>
  </main>

  <!-- ======= LÓGICA ======= -->
  <script>
    /* ===== Config ===== */
    // Reemplaza por TU endpoint de Apps Script si usas otro:
    const API_BASE = 'https://script.google.com/macros/s/AKfycbxQsD4XJICmZg-5eiZIAEjJ3GZz-GmqvhvMWtiznEOu7SafIKxWopo5iIVy7ufrq_qq/exec';

    /* ===== Helpers ===== */
    const $ = s => document.querySelector(s);
    const nf = new Intl.NumberFormat('en-US');
    function num(v){ return Number(String(v).replace(/[^\d.-]/g,'')) || 0 }
    function onlyDMY(s){ return String(s).split(/\s+/)[0] }
    function parseDMY(s){
      const [dd,mm,yy] = onlyDMY(s).split('/').map(n=>parseInt(n,10));
      if(!dd||!mm||!yy) return null;
      return new Date(yy,mm-1,dd);
    }
    function pick(o, ...keys){
      for (const k of keys){
        if (o && Object.prototype.hasOwnProperty.call(o,k)) return o[k];
      }
      return undefined;
    }

    /* ===== DOM ===== */
    const q = $('#q'), btnBuscar=$('#btnBuscar'), btnLimpiar=$('#btnLimpiar');
    const lblCodigo=$('#lblCodigo'), lblSuministro=$('#lblSuministro'), lblKBmin=$('#lblKBmin'),
          lblCritico=$('#lblCritico'), lblUltInv=$('#lblUltInv'), lblUltFec=$('#lblUltFec'),
          lblProm30=$('#lblProm30'), lblAct=$('#lblActualizado'), ttlChartEl=$('#ttlChart');

    let chart, searchCtrl=null, itemCtrl=null;
    const mem = new Map();

    /* ===== Normalización ===== */
    function normalizePoints(raw){
      const rows = [];
      (raw||[]).forEach(p=>{
        if (Array.isArray(p)){
          const f=p[0], inv=p[1];
          if (f!=null && inv!=null) rows.push({fecha:onlyDMY(f), inventario:num(inv)});
          return;
        }
        if (p && typeof p==='object'){
          const f = pick(p,'Fecha','fecha','FECHA');
          const v = pick(p,'Inventario','inventario','INVENTARIO');
          if (f!=null && v!=null) rows.push({fecha:onlyDMY(f), inventario:num(v)});
        }
      });
      // agrupa por fecha
      const agg = new Map();
      rows.forEach(r=> agg.set(r.fecha,(agg.get(r.fecha)||0)+r.inventario));
      const out = Array.from(agg.entries())
        .map(([fecha,inventario])=>({fecha,inventario,_d:parseDMY(fecha)}))
        .filter(r=>r._d && !isNaN(r._d))
        .sort((a,b)=>a._d-b._d);
      return out;
    }
    function sma30(rows){
      const out = new Array(rows.length).fill(null);
      for(let i=0;i<rows.length;i++){
        const to=rows[i]._d, from=new Date(to); from.setDate(from.getDate()-29);
        let s=0,c=0;
        for(let k=i;k>=0 && rows[k]._d>=from;k--){ s+=rows[k].inventario; c++; }
        out[i]=c? s/c : null;
      }
      return out;
    }

    /* ===== Buscar ===== */
    let tDeb=null;
    q.addEventListener('keydown', e=>{ if(e.key==='Enter') launchSearch(); });
    btnBuscar.addEventListener('click', launchSearch);
    btnLimpiar.addEventListener('click', ()=>{ q.value=''; renderItem(null); });

    function launchSearch(){
      const term = q.value.trim();
      if(!term) return;
      if (/^\d{5,}$/.test(term)) fetchItem(term);
      else doSearch(term);
    }
    async function doSearch(term){
      try{
        if (mem.has(term)) return; // ya cacheado
        if (searchCtrl) searchCtrl.abort();
        searchCtrl = new AbortController();
        const url = new URL(API_BASE);
        url.searchParams.set('action','search'); url.searchParams.set('q', term);
        const res = await fetch(url,{cache:'no-store', signal:searchCtrl.signal});
        const data = await res.json();
        mem.set(term, data.items||[]);
        // si hay coincidencia única por nombre, pedirla
        if ((data.items||[]).length===1 && data.items[0].code){
          fetchItem(String(data.items[0].code));
        }
      }catch(e){ if(e.name!=='AbortError') console.error(e); }
    }

    function setLoading(b){ btnBuscar.disabled=b; btnBuscar.textContent=b?'Buscando…':'Buscar'; }

    async function fetchItem(code){
      try{
        setLoading(true);
        const k='item:'+code, cached = localStorage.getItem(k);
        if (cached) renderItem(JSON.parse(cached), true);

        if (itemCtrl) itemCtrl.abort();
        itemCtrl = new AbortController();
        const url = new URL(API_BASE);
        url.searchParams.set('action','item'); url.searchParams.set('code', code);
        const res = await fetch(url,{cache:'no-store', signal:itemCtrl.signal});
        const data = await res.json();

        const meta = {
          codigo    : pick(data,'codigo','Código','CODIGO','code') || code,
          suministro: pick(data,'suministro','Suministro','SUMINISTRO') || '',
          kb_min    : num(pick(data,'kb_min','KB_min','KB_MIN')),
          critico   : num(pick(data,'critico','Critico','CRITICO'))
        };
        const puntos = pick(data,'puntos','data','rows','Items','ITEMS') || [];
        const rows   = normalizePoints(puntos);

        data.__meta = meta; data.__rows = rows;
        localStorage.setItem(k, JSON.stringify(data));
        renderItem(data);
      }catch(e){
        if (e.name!=='AbortError'){ console.error(e); alert('No se pudo obtener el detalle.'); }
      }finally{ setLoading(false); }
    }

    /* ===== Render ===== */
    function renderItem(payload, fromCache=false){
      if (!payload){
        lblCodigo.textContent = lblSuministro.textContent = lblKBmin.textContent =
        lblCritico.textContent = lblUltInv.textContent = lblUltFec.textContent =
        lblProm30.textContent = '—';
        ttlChartEl.textContent='Curva de Inventario';
        if(chart) chart.destroy();
        lblAct.textContent='';
        return;
      }

      const meta = payload.__meta || {};
      const rows = payload.__rows || [];

      const labels = rows.map(r=>r.fecha);
      const inv    = rows.map(r=>r.inventario);
      const avg    = sma30(rows);
      const last   = rows[rows.length-1] || null;

      // panel
      lblCodigo.textContent     = meta.codigo || '—';
      lblSuministro.textContent = meta.suministro || '—';
      lblKBmin.textContent      = Number.isFinite(meta.kb_min) ? nf.format(meta.kb_min) : '—';
      lblCritico.textContent    = Number.isFinite(meta.critico) ? nf.format(meta.critico) : '—';
      lblUltInv.textContent     = last ? nf.format(last.inventario) : '—';
      lblUltFec.textContent     = last ? last.fecha : '—';
      lblProm30.textContent     = (avg.length && avg[avg.length-1]!=null)? nf.format(avg[avg.length-1]) : '—';
      lblAct.textContent        = (fromCache?'(caché) ':'') + new Date().toLocaleString();
      ttlChartEl.textContent    = `${meta.codigo||'—'} — ${meta.suministro||'—'}`;

      const datasets = [
        { label:'Inventario', data:inv, borderColor:'rgba(59,130,246,1)', backgroundColor:'rgba(59,130,246,.15)', pointRadius:2, borderWidth:2, tension:.2, fill:'origin' },
        { label:'Promedio 30 días', data:avg, borderColor:'rgba(100,116,139,1)', backgroundColor:'rgba(100,116,139,.08)', pointRadius:0, borderWidth:2, borderDash:[6,4], tension:.2, fill:false }
      ];
      if (Number.isFinite(meta.kb_min)){
        datasets.push({ label:'KB_min', data:labels.map(()=>meta.kb_min), borderColor:'rgba(234,179,8,1)', backgroundColor:'rgba(234,179,8,.10)', pointRadius:0, borderWidth:1, fill:false });
      }
      if (Number.isFinite(meta.critico)){
        datasets.push({ label:'Crítico', data:labels.map(()=>meta.critico), borderColor:'rgba(239,68,68,1)', backgroundColor:'rgba(239,68,68,.10)', pointRadius:0, borderWidth:1, fill:false });
      }

      const lastValuePlugin = {
        id:'lastValuePlugin',
        afterDatasetsDraw(c){
          const {ctx} = c; ctx.save(); ctx.font='12px sans-serif'; ctx.textBaseline='middle';
          c.data.datasets.forEach((ds,i)=>{
            const meta = c.getDatasetMeta(i); if(!meta?.data?.length) return;
            let idx=ds.data.length-1; while(idx>=0 && (ds.data[idx]==null||!isFinite(ds.data[idx]))) idx--;
            if (idx<0) return;
            const pt=meta.data[idx]; const v=+ds.data[idx];
            ctx.fillStyle = Array.isArray(ds.borderColor)?ds.borderColor[0]:ds.borderColor;
            ctx.fillText(nf.format(v), pt.x+6, pt.y);
          });
          ctx.restore();
        }
      };

      function xTick(value,index,ticks){
        const first=index===0, last=index===ticks.length-1;
        if(first||last) return labels[index];
        const d0=parseDMY(labels[0]), di=parseDMY(labels[index]);
        const diff=Math.round((di-d0)/(1000*60*60*24));
        return diff%14===0 ? labels[index] : '';
      }

      if(chart) chart.destroy();
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx,{
        type:'line',
        data:{labels,datasets},
        options:{
          responsive:true, maintainAspectRatio:false,
          interaction:{intersect:false,mode:'index'},
          layout:{padding:{right:60}},
          plugins:{legend:{position:'top'}},
          scales:{x:{ticks:{autoSkip:false,maxRotation:0,callback:xTick}}, y:{beginAtZero:false}}
        },
        plugins:[lastValuePlugin]
      });

      if (!rows.length){
        console.warn('Sin puntos después de normalizar. Revisa estructura de payload:', payload);
      }
    }

    /* ===== SW & PWA ===== */
    if ('serviceWorker' in navigator){
      window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(console.error));
    }
    let deferredPrompt=null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault(); deferredPrompt=e; $('#btnInstall').style.display='inline-block';
    });
    $('#btnInstall').addEventListener('click', async ()=>{
      if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null;
    });
  </script>
</body>
</html>
