<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CEDIS PanamÃ¡ â€“ Curvas de Inventario</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0d6efd">
  <link rel="icon" href="icons/icon-192.png">

  <!-- UI bÃ¡sica (Bootstrap lite) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js + adapter de fechas (date-fns) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <style>
    body{ background:#f6f8fb; }
    .card{ border:0; box-shadow:0 8px 22px rgba(0,0,0,.06); }
    .brand{ height:42px; }
    .muted{ color:#6c757d; }
    .skeleton{ background:linear-gradient(90deg,#eee,#f5f5f5,#eee); background-size:200% 100%; animation:sh 1.2s infinite; }
    @keyframes sh{ 0%{background-position:200% 0} 100%{background-position:-200% 0} }
    .spinner{ width:18px; height:18px; border:3px solid #d8e2f0; border-top-color:#0d6efd; border-radius:50%; animation:sp .8s linear infinite; display:inline-block; }
    @keyframes sp{ to{ transform:rotate(360deg) } }
    .smallcaps{ font-variant-numeric: tabular-nums; }
  </style>
</head>

<body>
  <nav class="navbar navbar-dark" style="background:#0d6efd;">
    <div class="container">
      <img class="brand me-2" src="icons/icon-192.png" alt="CSS">
      <span class="navbar-brand mb-0 h1">CEDIS Panama â€“ Curvas de Inventario</span>
      <button id="installBtn" class="btn btn-light btn-sm ms-auto">Instalar</button>
    </div>
  </nav>

  <main class="container py-4">
    <!-- Buscador -->
    <div class="card mb-3">
      <div class="card-body">
        <label class="form-label fw-semibold">Busca por <u>cÃ³digo</u> o <u>nombre de suministro</u></label>
        <div class="input-group">
          <input id="q" class="form-control" placeholder="Ej: 101098001 o amlodipina" autocomplete="off">
          <button id="btnBuscar" class="btn btn-primary">Buscar</button>
          <button id="btnLimpiar" class="btn btn-outline-secondary">Limpiar</button>
        </div>
        <div id="suggest" class="list-group mt-2" style="max-height:230px; overflow:auto; display:none;"></div>
      </div>
    </div>

    <div class="row g-3">
      <!-- Detalle -->
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Detalle</h5>
            <div id="detail">
              <div class="muted">CÃ³digo: <span id="d-codigo">â€”</span></div>
              <div class="muted">Suministro: <span id="d-suministro">â€”</span></div>
              <div class="muted">KB_min: <span id="d-kb">â€”</span></div>
              <div class="muted">CrÃ­tico: <span id="d-crit">â€”</span></div>
              <div class="muted">Promedio 30 dÃ­as: <span id="d-prom">â€”</span></div>
              <div class="muted">Ãšltimo inventario: <span id="d-ult">â€”</span></div>
              <div class="muted">Fecha Ãºltimo: <span id="d-fecha">â€”</span></div>
              <div class="mt-2 small text-muted">Fuente: API Inventario CEDIS (Apps Script)</div>
            </div>
          </div>
        </div>
      </div>

      <!-- GrÃ¡fico -->
      <div class="col-lg-8">
        <div class="card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <h5 class="card-title mb-0"><span id="chartTitle">Curva de Inventario</span></h5>
              <small id="now" class="text-muted"></small>
            </div>
            <div id="chartWrap" class="mt-2" style="height:420px; position:relative;">
              <canvas id="chart" height="400"></canvas>
              <div id="loading" style="position:absolute; inset:0; display:none; align-items:center; justify-content:center;">
                <span class="spinner me-2"></span> Cargandoâ€¦
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <p class="text-center text-muted mt-4 small">v1.2 â€¢ PWA â€¢ Actualiza en tiempo real</p>
  </main>

<script>
/* =================== CONFIG =================== */
// ðŸ‘‡ Reemplaza por la URL de despliegue de TU WebApp de Apps Script (la que devuelve JSON)
// Debe terminar sin â€œ/â€ (ej: https://script.google.com/macros/s/AKfycb.../exec)
const API_BASE = 'https://script.google.com/macros/s/AKfycbxQsD4XJICmZg-5eiZIAEjJ3GZz-GmqvhvMWtiznEOu7SafIKxWopo5iIVy7ufrq_qq/exec';

/* =================== UTILIDADES =================== */
const fmtNum = new Intl.NumberFormat('es-PA', { maximumFractionDigits: 0 });
const fmtNum1 = new Intl.NumberFormat('es-PA', { maximumFractionDigits: 1 });
const fmtDate = (d) => {
  try { return new Date(d).toLocaleDateString('es-PA'); } catch { return 'â€”'; }
};
const byDateAsc = (a,b)=> (new Date(a.fecha)) - (new Date(b.fecha));

function movingAvg(series, days=30){
  // series: [{fecha:'yyyy-mm-dd', inventario:number}] ordenada por fecha asc
  const out = [];
  let win = [];
  let sum = 0;
  const DAY = 86400000;
  for(const p of series){
    const t = new Date(p.fecha).getTime();
    // quitar puntos fuera de ventana (t - (days-1)d)
    while (win.length && (t - win[0].t) >= days*DAY){
      sum -= win[0].v; win.shift();
    }
    win.push({t, v:p.inventario});
    sum += p.inventario;
    out.push({x:new Date(t), y: sum / win.length});
  }
  return out;
}

/* =============== CACHÃ‰ (memoria) =============== */
const mem = new Map();  // LRU sencillo
function cacheGet(k){ return mem.get(k); }
function cacheSet(k,v){ mem.set(k,v); if(mem.size>40){ mem.delete(mem.keys().next().value); } }

/* =============== UI =============== */
const els = {
  q: document.getElementById('q'),
  btnBuscar: document.getElementById('btnBuscar'),
  btnLimpiar: document.getElementById('btnLimpiar'),
  suggest: document.getElementById('suggest'),
  dCodigo: document.getElementById('d-codigo'),
  dSum: document.getElementById('d-suministro'),
  dKB: document.getElementById('d-kb'),
  dCR: document.getElementById('d-crit'),
  dProm: document.getElementById('d-prom'),
  dUlt: document.getElementById('d-ult'),
  dFecha: document.getElementById('d-fecha'),
  chartTitle: document.getElementById('chartTitle'),
  loading: document.getElementById('loading'),
  now: document.getElementById('now'),
};
els.now.textContent = new Date().toLocaleString('es-PA');

let chart;
function ensureChart(){
  if(chart) return chart;
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type:'line',
    data:{ datasets:[] },
    options:{
      animation:false,
      responsive:true,
      maintainAspectRatio:false,
      parsing:false,
      scales:{
        x: { type:'time', time:{ unit:'day' }, ticks:{ maxRotation:0, autoSkip:true } },
        y: { beginAtZero:true }
      },
      plugins:{
        legend:{ labels:{ usePointStyle:true } },
        tooltip:{ mode:'index', intersect:false }
      },
      elements:{
        line:{ borderWidth:2, tension:.25 },
        point:{ radius:2 }
      }
    }
  });
  return chart;
}

function setDetailPlaceholders(){
  els.dCodigo.textContent = 'â€”';
  els.dSum.textContent = 'â€”';
  els.dKB.textContent = 'â€”';
  els.dCR.textContent = 'â€”';
  els.dProm.textContent = 'â€”';
  els.dUlt.textContent = 'â€”';
  els.dFecha.textContent = 'â€”';
}

function render(code, meta, puntos){
  // puntos ordenados
  puntos.sort(byDateAsc);

  // dataset inventario
  const inv = puntos.map(p => ({x:new Date(p.fecha), y:p.inventario}));

  // MA 30 dÃ­as
  const ma30 = movingAvg(puntos, 30);

  // Ãºltimo
  const last = puntos[puntos.length-1] || null;
  const prom30 = ma30.length ? ma30[ma30.length-1].y : null;

  // Detalle
  els.dCodigo.textContent = code || 'â€”';
  els.dSum.textContent = meta?.suministro || 'â€”';
  els.dKB.textContent = (meta?.kb_min!=null) ? fmtNum.format(meta.kb_min) : 'â€”';
  els.dCR.textContent = (meta?.critico!=null) ? fmtNum.format(meta.critico) : 'â€”';
  els.dProm.textContent = prom30!=null ? fmtNum.format(prom30) : 'â€”';
  els.dUlt.textContent = last ? fmtNum.format(last.inventario) : 'â€”';
  els.dFecha.textContent = last ? fmtDate(last.fecha) : 'â€”';

  // TÃ­tulo
  document.title = `CEDIS â€“ ${code}`; 
  els.chartTitle.textContent = `${code} â€” ${meta?.suministro || ''}`.trim();

  // LÃ­neas horizontales (KB_min y CrÃ­tico) como datasets stepped
  const x0 = inv.length ? inv[0].x : new Date();
  const x1 = inv.length ? inv[inv.length-1].x : new Date();

  const ds = [
    {label:'Inventario', data:inv, borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,.15)', fill:true},
    {label:'Promedio 30 dÃ­as', data:ma30, borderDash:[6,6], borderColor:'#64748b', pointRadius:0},
  ];

  if (meta?.kb_min!=null){
    ds.push({
      label:'KB_min',
      data:[{x:x0,y:meta.kb_min},{x:x1,y:meta.kb_min}],
      borderColor:'#facc15', pointRadius:0, fill:false, stepped:true
    });
  }
  if (meta?.critico!=null){
    ds.push({
      label:'CrÃ­tico',
      data:[{x:x0,y:meta.critico},{x:x1,y:meta.critico}],
      borderColor:'#ef4444', pointRadius:0, fill:false, stepped:true
    });
  }

  const ch = ensureChart();
  ch.data.datasets = ds;
  ch.update('none');
}

/* =============== API =============== */
let acSearch = null;
let acItem = null;

async function apiSearch(q){
  const key = `search:${q}`;
  const cached = cacheGet(key);
  if (cached) return cached;

  if (acSearch) acSearch.abort();
  acSearch = new AbortController();

  const url = `${API_BASE}?action=search&q=${encodeURIComponent(q)}`;
  const r = await fetch(url, {signal:acSearch.signal});
  const j = await r.json();
  cacheSet(key, j?.items || []);
  return j?.items || [];
}

async function apiItem(code){
  const key = `item:${code}`;
  const cached = cacheGet(key);
  if (cached) return cached;

  if (acItem) acItem.abort();
  acItem = new AbortController();

  const url = `${API_BASE}?action=item&code=${encodeURIComponent(code)}`;
  const r = await fetch(url, {signal:acItem.signal});
  const j = await r.json();
  // Esperado por tu Apps Script: {codigo, kb_min, critico, puntos:[{fecha:'yyyy-mm-dd', inventario:n}]}
  cacheSet(key, j);
  return j;
}

/* =============== INTERACCIÃ“N =============== */
function showSuggest(items){
  const box = els.suggest;
  box.innerHTML = '';
  if (!items?.length){ box.style.display='none'; return; }
  for(const it of items){
    const a = document.createElement('button');
    a.type = 'button';
    a.className = 'list-group-item list-group-item-action';
    a.textContent = `${it.codigo} â€” ${it.suministro}`;
    a.addEventListener('click', ()=>{
      els.q.value = it.codigo;
      box.style.display='none';
      buscar();
    });
    box.appendChild(a);
  }
  box.style.display = 'block';
}

let suggestTimer=null;
els.q.addEventListener('input', ()=>{
  const v = els.q.value.trim();
  setDetailPlaceholders();
  if (suggestTimer) clearTimeout(suggestTimer);
  if (!v){ els.suggest.style.display='none'; return; }
  suggestTimer = setTimeout(async ()=>{
    try{
      const items = await apiSearch(v.toLowerCase());
      showSuggest(items);
    }catch{ /*noop*/ }
  }, 220);
});

async function buscar(){
  els.suggest.style.display='none';
  const v = els.q.value.trim();
  if (!v) return;

  els.loading.style.display='flex';
  setDetailPlaceholders();
  render('', {suministro:''}, []); // limpia grÃ¡fico rÃ¡pido

  try{
    // Si el usuario escribiÃ³ un nombre, toma el primer match para obtener el cÃ³digo
    let code = v;
    if (!/^\d{6,}$/.test(v)){
      const items = await apiSearch(v.toLowerCase());
      if (!items.length) { els.loading.style.display='none'; return; }
      code = items[0].codigo;
      els.q.value = code;
    }

    const data = await apiItem(code);
    const meta = { suministro: (data?.suministro || data?.descripcion || ''), kb_min:data?.kb_min, critico:data?.critico };
    render(data?.codigo || code, meta, data?.puntos || []);
  }catch(e){
    console.error(e);
  }finally{
    els.loading.style.display='none';
  }
}

els.btnBuscar.addEventListener('click', buscar);
els.btnLimpiar.addEventListener('click', ()=>{
  els.q.value = '';
  setDetailPlaceholders();
  render('',{suministro:''},[]);
});

/* =============== PWA Register =============== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(()=>{}));
}

/* =============== Instalar (Add to Home) =============== */
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt = e;
  document.getElementById('installBtn').disabled = false;
});
document.getElementById('installBtn').addEventListener('click', async ()=>{
  if (!deferredPrompt) return;
  deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null;
});
</script>
</body>
</html>
