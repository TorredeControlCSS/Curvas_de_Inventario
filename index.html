<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario CEDIS — Curvas en tiempo real</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="icon-192.png">

  <!-- Performance hints -->
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="//script.google.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>

  <!-- UI (Tailwind CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <style>
    .card{ box-shadow:0 6px 24px rgba(0,0,0,.08), 0 2px 6px rgba(0,0,0,.04); }
    #suggestions li{ cursor:pointer }
    .disabled{ opacity:.5; pointer-events:none }
  </style>
</head>
<body class="bg-white text-slate-800 min-h-screen">
  <!-- HEADER -->
  <header class="bg-sky-600 text-white">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <!-- LOGO (local). Si quieres tu base64, pega tu cadena en el src -->
        <img src="icon-192.png"
             alt="DINALOG - CSS Panamá"
             class="h-10 sm:h-12 md:h-16 w-auto mr-3 select-none"
             loading="eager" decoding="async"/>
        <h1 class="text-lg sm:text-2xl font-semibold">CEDIS Panama – Curvas de Inventario</h1>
      </div>
      <button id="btnInstall" class="hidden bg-white/10 hover:bg-white/20 px-3 py-1 rounded">Instalar</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- BUSCADOR -->
    <section class="card bg-white rounded-2xl p-4">
      <div class="flex flex-col gap-3">
        <label class="text-sm text-slate-500">
          Busca por <b>código</b> o <b>nombre de suministro</b>
        </label>

        <div class="relative">
          <input id="q" type="search" placeholder="Ej.: 101098001 o amlodipina"
                 class="w-full rounded-xl border border-slate-300 px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-sky-500" autocomplete="off">
          <button id="btnClearInput" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 text-xl hidden" aria-label="Limpiar">×</button>
          <ul id="suggestions" class="absolute z-10 mt-1 w-full bg-white border border-slate-200 rounded-xl max-h-64 overflow-auto hidden"></ul>
        </div>

        <div class="flex gap-2">
          <button id="btnBuscar" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-xl">Buscar</button>
          <button id="btnLimpiar" class="bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-xl">Limpiar</button>
        </div>
      </div>
    </section>

    <!-- PANEL DATOS + GRÁFICO -->
    <section class="grid md:grid-cols-3 gap-4">
      <!-- DETALLE -->
      <div class="card bg-white rounded-2xl p-4 md:col-span-1 space-y-3">
        <h2 class="font-semibold text-slate-700">Detalle</h2>
        <div class="text-sm space-y-1">
          <div><span class="text-slate-500">Código:</span> <span id="lblCodigo" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Suministro:</span> <span id="lblSuministro">—</span></div>
          <div><span class="text-slate-500">KB_min:</span> <span id="lblKBmin" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Crítico:</span> <span id="lblCritico" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Promedio 30 días:</span> <span id="lblProm30" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Último inventario:</span> <span id="lblUltInv" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Fecha último:</span> <span id="lblUltFec" class="font-mono">—</span></div>
          <div class="text-xs text-slate-500 pt-2">Fuente: API Inventario CEDIS (Apps Script)</div>
        </div>
      </div>

      <!-- GRÁFICO -->
      <div class="card bg-white rounded-2xl p-4 md:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h2 id="ttlChart" class="font-semibold text-slate-700">Curva de Inventario</h2>
          <div class="text-xs text-slate-500" id="lblActualizado">—</div>
        </div>
        <div class="h-[360px]">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </section>
  </main>

  <footer class="py-8 text-center text-xs text-slate-400">
    v1.2 • PWA • Actualiza en tiempo real
  </footer>

  <!-- ======== APP SCRIPT ======== -->
  <script>
  /* ========= CONFIG ========= */
  const API_BASE = 'https://script.google.com/macros/s/AKfycbxQsD4XJICmZg-5eiZIAEjJ3GZz-GmqvhvMWtiznEOu7SafIKxWopo5iIVy7ufrq_qq/exec';

  /* ========= Estado & helpers ========= */
  const el  = s => document.querySelector(s);
  const els = s => Array.from(document.querySelectorAll(s));

  const q              = el('#q');
  const btnClearInput  = el('#btnClearInput');
  const suggestions    = el('#suggestions');
  const btnBuscar      = el('#btnBuscar');
  const btnLimpiar     = el('#btnLimpiar');

  const lblCodigo   = el('#lblCodigo');
  const lblSuministro = el('#lblSuministro');
  const lblKBmin    = el('#lblKBmin');
  const lblCritico  = el('#lblCritico');
  const lblUltInv   = el('#lblUltInv');
  const lblUltFec   = el('#lblUltFec');
  const lblAct      = el('#lblActualizado');
  const lblProm30   = el('#lblProm30');
  const ttlChartEl  = el('#ttlChart');

  let deferPrompt; // PWA install event
  let chart;
  const nf = new Intl.NumberFormat('en-US'); // formato unificado
  const fmtDM = new Intl.DateTimeFormat('es-PA',{day:'2-digit',month:'2-digit'});

  /* ========= INPUT UX ========= */
  q.addEventListener('input', () => {
    btnClearInput?.classList.toggle('hidden', q.value.trim()==='');
  });
  btnClearInput?.addEventListener('click', () => {
    q.value=''; btnClearInput.classList.add('hidden'); hideSuggestions();
  });

  let tDeb = null;
  q.addEventListener('input', () => {
    clearTimeout(tDeb);
    const term = q.value.trim();
    if (term.length < 2) { hideSuggestions(); return; }
    tDeb = setTimeout(() => doSearch(term), 250);
  });

  q.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter') { hideSuggestions(); launchSearch(); }
  });

  btnBuscar.addEventListener('click', launchSearch);
  btnLimpiar.addEventListener('click', () => {
    q.value = '';
    btnClearInput?.classList.add('hidden');
    hideSuggestions();
    renderItem(null);
  });

  /* ========= Sugerencias ========= */
  function showSuggestions(items){
    if (!items || !items.length) { hideSuggestions(); return; }
    items = items.slice(0, 10);
    suggestions.innerHTML = items.map(it => (
      `<li class="px-3 py-2 hover:bg-slate-100 border-b border-slate-100" data-cod="${it.codigo}">
         <div class="font-medium">${it.suministro || ''}</div>
         <div class="text-xs text-slate-500">${it.codigo || ''}</div>
       </li>`
    )).join('');
    suggestions.classList.remove('hidden');
    els('#suggestions li').forEach(li => {
      li.addEventListener('click', () => {
        const cod = li.getAttribute('data-cod');
        q.value = cod;
        hideSuggestions();
        fetchItem(cod);
      });
    });
  }
  function hideSuggestions(){ suggestions.classList.add('hidden'); suggestions.innerHTML=''; }

  /* ========= Buscador con cancelación ========= */
  let searchCtrl = null, itemCtrl = null;

  async function doSearch(term){
    try{
      if (searchCtrl) searchCtrl.abort();
      searchCtrl = new AbortController();

      const url = new URL(API_BASE);
      url.searchParams.set('action','search');
      url.searchParams.set('q', term);

      const res = await fetch(url, {cache:'no-store', signal: searchCtrl.signal});
      const data = await res.json();
      showSuggestions(data.items || []);
    }catch(e){
      if (e.name !== 'AbortError') console.error('search error', e);
    }
  }

  function setLoading(isLoading){
    btnBuscar.disabled = isLoading;
    btnBuscar.textContent = isLoading ? 'Buscando…' : 'Buscar';
  }

  function launchSearch(){
    const term = q.value.trim();
    if (!term) return;
    if (/^\d{6,}$/.test(term)) fetchItem(term);
    else doSearch(term);
  }

  /* ========= Fechas robustas ========= */
  // Acepta DD/MM, DD/MM/YYYY o ISO YYYY-MM-DD
  function parseDateSmart(s) {
    if (!s) return null;
    const str = String(s).trim();
    if (str.includes('-')) { // ISO
      const d = new Date(str);
      return isNaN(d) ? null : d;
    }
    const parts = str.split('/');
    if (parts.length >= 2) {
      const d = parseInt(parts[0],10), m = parseInt(parts[1],10);
      let y = parts.length >= 3 ? parseInt(parts[2],10) : (new Date()).getFullYear();
      if (!Number.isFinite(d)||!Number.isFinite(m)||!Number.isFinite(y)) return null;
      return new Date(Date.UTC(y, m-1, d)); // UTC para evitar saltos por huso
    }
    const d = new Date(str);
    return isNaN(d) ? null : d;
  }
  function toISODateUTC(d) {
    const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,'0'), day=String(d.getUTCDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  // Agrupa por fecha sumando inventario
  function groupByDateSum(points){
    const bucket = {};
    for (const p of (points||[])) {
      const d = parseDateSmart(p.fecha);
      const inv = Number(p.inventario || 0);
      if (!d || !Number.isFinite(inv)) continue;
      const key = toISODateUTC(d);
      bucket[key] = (bucket[key] || 0) + inv;
    }
    return Object.keys(bucket)
      .sort((a,b)=> new Date(a) - new Date(b))
      .map(fecha => ({ fecha, inventario: bucket[fecha] }));
  }

  // SMA 30 días O(n)
  function sma30(labelsISO, serie){
    const n = labelsISO.length;
    const dates = labelsISO.map(s=> new Date(s));
    const out = Array(n).fill(null);
    let left = 0, sum = 0;
    for (let right=0; right<n; right++){
      sum += Number(serie[right]||0);
      const to = dates[right];
      const from = new Date(to); from.setUTCDate(from.getUTCDate()-29);
      while (left<=right && dates[left] < from) { sum -= Number(serie[left]||0); left++; }
      const count = right-left+1;
      out[right] = count>0 ? sum/count : null;
    }
    return out;
  }

  /* ========= Item con cache + cancelación ========= */
  async function fetchItem(code){
    try{
      setLoading(true);

      // 1) Render inmediato si hay caché
      const cacheKey = 'item:' + code;
      const cached = localStorage.getItem(cacheKey);
      if (cached) renderItem(JSON.parse(cached), true);

      // 2) Cancela llamada anterior y pide el item
      if (itemCtrl) itemCtrl.abort();
      itemCtrl = new AbortController();

      const url = new URL(API_BASE);
      url.searchParams.set('action','item');
      url.searchParams.set('code', code);
      const res = await fetch(url, {cache:'no-store', signal: itemCtrl.signal});
      const data = await res.json();

      // 3) Si falta el nombre, intenta obtenerlo por 'search'
      if (!data.suministro) {
        try {
          if (searchCtrl) searchCtrl.abort();
          searchCtrl = new AbortController();
          const sUrl = new URL(API_BASE);
          sUrl.searchParams.set('action','search');
          sUrl.searchParams.set('q', code);
          const sRes = await fetch(sUrl, {cache:'no-store', signal: searchCtrl.signal});
          const sData = await sRes.json();
          const hit = (sData.items||[]).find(it => (it.codigo||'') == String(code));
          if (hit?.suministro) data.suministro = hit.suministro;
        } catch(_) {}
      }

      localStorage.setItem(cacheKey, JSON.stringify(data));
      renderItem(data);
    }catch(e){
      if (e.name !== 'AbortError') {
        console.error('item error', e);
        alert('No se pudo obtener el detalle. Revisa la conexión o el código.');
      }
    } finally {
      setLoading(false);
    }
  }

  /* ========= Render ========= */
  function renderItem(data, fromCache=false){
    // Reset
    if (!data) {
      lblCodigo.textContent = '—';
      lblSuministro.textContent = '—';
      lblKBmin.textContent = '—';
      lblCritico.textContent = '—';
      lblUltInv.textContent = '—';
      lblUltFec.textContent = '—';
      lblProm30.textContent = '—';
      lblAct.textContent = '—';
      ttlChartEl.textContent = 'Curva de Inventario';
      if (chart) chart.destroy();
      return;
    }

    // 1) Consolidar por día y ordenar
    const puntosRaw = Array.isArray(data.puntos) ? data.puntos : [];
    const puntos = groupByDateSum(puntosRaw);

    // 2) Series
    const labelsISO = puntos.map(p=>p.fecha);                // ISO YYYY-MM-DD
    const labelsUI  = labelsISO.map(s => fmtDM.format(new Date(s)));
    const inv       = puntos.map(p=>Number(p.inventario||0));
    const last      = puntos[puntos.length-1];

    // 3) SMA-30
    const avg30 = sma30(labelsISO, inv);
    const lastAvg = avg30[avg30.length-1];

    // 4) Panel
    lblCodigo.textContent     = data.codigo || '—';
    lblSuministro.textContent = data.suministro || '—';
    lblKBmin.textContent      = (data.kb_min != null ? nf.format(+data.kb_min) : '—');
    lblCritico.textContent    = (data.critico != null ? nf.format(+data.critico) : '—');
    lblUltInv.textContent     = last ? nf.format(Number(last.inventario||0)) : '—';
    lblUltFec.textContent     = last ? fmtDM.format(new Date(last.fecha)) : '—';
    lblProm30.textContent     = (lastAvg != null ? nf.format(lastAvg) : '—');
    lblAct.textContent        = (fromCache?'(caché) ':'') + new Date().toLocaleString();
    ttlChartEl.textContent    = `${data.codigo || '—'} — ${data.suministro || '—'}`;

    // 5) Datasets
    const datasets = [
      {
        label:'Inventario',
        data: inv,
        borderColor: 'rgba(59,130,246,1)',
        backgroundColor: 'rgba(59,130,246,0.15)',
        pointRadius: 2,
        borderWidth: 2,
        tension: .2,
        fill: 'origin',
        clip: false
      },
      {
        label: 'Promedio 30 días',
        data: avg30,
        borderColor: 'rgba(100,116,139,1)',
        backgroundColor: 'rgba(100,116,139,0.08)',
        pointRadius: 0,
        borderWidth: 2,
        borderDash: [6,4],
        tension: .2,
        fill: false,
        clip: false
      }
    ];
    if (Number.isFinite(+data.kb_min)) {
      datasets.push({
        label:'KB_min',
        data: labelsISO.map(()=> +data.kb_min),
        borderColor: 'rgba(234,179,8,1)',
        backgroundColor: 'rgba(234,179,8,0.10)',
        pointRadius:0,
        borderWidth:1,
        fill: false,
        clip: false
      });
    }
    if (Number.isFinite(+data.critico)) {
      datasets.push({
        label:'Crítico',
        data: labelsISO.map(()=> +data.critico),
        borderColor: 'rgba(239,68,68,1)',
        backgroundColor: 'rgba(239,68,68,0.10)',
        pointRadius:0,
        borderWidth:1,
        fill: false,
        clip: false
      });
    }

    // Plugin: rotula último valor a la derecha
    const lastValuePlugin = {
      id: 'lastValuePlugin',
      afterDatasetsDraw(chart, args) {
        const {ctx} = chart;
        ctx.save();
        ctx.font = '12px sans-serif';
        ctx.textBaseline = 'middle';
        chart.data.datasets.forEach((ds, i) => {
          const meta = chart.getDatasetMeta(i);
          if (!meta?.data?.length) return;
          let idx = ds.data.length-1;
          while (idx>=0 && (ds.data[idx]==null || !isFinite(ds.data[idx]))) idx--;
          if (idx<0) return;
          const pt = meta.data[idx];
          const val = +ds.data[idx];
          if (!pt || !isFinite(val)) return;
          const x = pt.x + 6;
          const y = pt.y;
          ctx.fillStyle = Array.isArray(ds.borderColor) ? ds.borderColor[0] : (ds.borderColor || '#334155');
          ctx.fillText(nf.format(val), x, y);
        });
        ctx.restore();
      }
    };

    // 6) Eje X: etiquetas limpias (inicio / cada 14 días / final)
    function xTickCallback(value, index, ticks){
      const labelsISOInner = chart?.data?._labelsISO || labelsISO;
      if (!labelsISOInner.length) return '';
      if (index===0) return fmtDM.format(new Date(labelsISOInner[0]));
      if (index===ticks.length-1) return fmtDM.format(new Date(labelsISOInner[labelsISOInner.length-1]));
      const d0 = new Date(labelsISOInner[0]);
      const di = new Date(labelsISOInner[index]);
      const diffDays = Math.round((di - d0)/86400000);
      return (diffDays % 14 === 0) ? fmtDM.format(di) : '';
    }

    // Render / Update
    const ctx = document.getElementById('chart').getContext('2d');
    const config = {
      type:'line',
      data:{ labels: labelsUI, datasets },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{ intersect:false, mode:'index' },
        layout:{ padding: { right: 60 } }, // espacio para etiquetas finales
        plugins:{
          legend:{ position:'top' },
          tooltip:{ callbacks:{ label(c){ return `${c.dataset.label}: ${nf.format(c.parsed.y)}`; } } },
          decimation:{ enabled:true, algorithm:'lttb', samples:200 }
        },
        scales: {
          x: {
            ticks: {
              autoSkip: false,
              maxRotation: 0,
              minRotation: 0,
              callback: xTickCallback
            }
          },
          y: { beginAtZero: false }
        }
      },
      plugins:[lastValuePlugin]
    };

    if (!chart) {
      chart = new Chart(ctx, config);
    } else {
      chart.data.labels = labelsUI;
      chart.data.datasets = datasets;
      chart.options.scales.x.ticks.callback = xTickCallback;
      chart.update();
    }
    // Guardamos las ISO para el callback
    chart.data._labelsISO = labelsISO;
  }

  /* ========= PWA / Service Worker ========= */
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    });
  }
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault(); deferPrompt = e;
    el('#btnInstall')?.classList.remove('hidden');
  });
  el('#btnInstall')?.addEventListener('click', async () => {
    if (!deferPrompt) return;
    deferPrompt.prompt(); await deferPrompt.userChoice;
    deferPrompt = null; el('#btnInstall')?.classList.add('hidden');
  });
  </script>
</body>
</html>