<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CEDIS Panama – Curvas de Inventario</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">

  <!-- Ícono / logo del header (usa tus archivos del repo) -->
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- Preconexión a la API (mejora TTFB) -->
  <link rel="preconnect" href="https://script.google.com" crossorigin>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1" defer></script>

  <style>
    .card{ box-shadow:0 6px 24px rgba(0,0,0,.08), 0 2px 6px rgba(0,0,0,.04); }
    #suggestions li{ cursor:pointer }
    .disabled{ opacity:.5; pointer-events:none }
  </style>
</head>
<body class="bg-white text-slate-800 min-h-screen">
  <!-- HEADER -->
  <header class="bg-sky-600 text-white">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="icons/icon-192.png" alt="DINALOG - CSS Panamá"
             class="h-10 sm:h-12 md:h-16 w-auto mr-2 select-none"
             loading="eager" decoding="async">
        <h1 class="text-lg sm:text-2xl font-semibold">CEDIS Panama – Curvas de Inventario</h1>
      </div>
      <button id="btnInstall" class="hidden bg-white/10 hover:bg-white/20 px-3 py-1 rounded">Instalar</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- BUSCADOR -->
    <section class="card bg-white rounded-2xl p-4">
      <div class="flex flex-col gap-3">
        <label class="text-sm text-slate-500">
          Busca por <b>código</b> o <b>nombre de suministro</b>
        </label>

        <div class="relative">
          <input id="q" type="search" placeholder="Ej.: 101098001 o amlodipina"
                 class="w-full rounded-xl border border-slate-300 px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-sky-500">
          <button id="btnClearInput" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 text-xl hidden" aria-label="Limpiar">×</button>
          <ul id="suggestions" class="absolute z-10 mt-1 w-full bg-white border border-slate-200 rounded-xl max-h-64 overflow-auto hidden"></ul>
        </div>

        <div class="flex gap-2">
          <button id="btnBuscar" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-xl">Buscar</button>
          <button id="btnLimpiar" class="bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-xl">Limpiar</button>
        </div>
      </div>
    </section>

    <!-- PANEL DATOS + GRÁFICO -->
    <section class="grid md:grid-cols-3 gap-4">
      <!-- DETALLE -->
      <div class="card bg-white rounded-2xl p-4 md:col-span-1 space-y-3">
        <h2 class="font-semibold text-slate-700">Detalle</h2>
        <div class="text-sm space-y-1">
          <div><span class="text-slate-500">Código:</span> <span id="lblCodigo" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Suministro:</span> <span id="lblSuministro">—</span></div>
          <div><span class="text-slate-500">KB_min:</span> <span id="lblKBmin" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Crítico:</span> <span id="lblCritico" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Promedio 30 días:</span> <span id="lblProm30" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Último inventario:</span> <span id="lblUltInv" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Fecha último:</span> <span id="lblUltFec" class="font-mono">—</span></div>
          <div class="text-xs text-slate-500 pt-2">Fuente: API Inventario CEDIS (Apps Script)</div>
        </div>
      </div>

      <!-- GRÁFICO -->
      <div class="card bg-white rounded-2xl p-4 md:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h2 id="ttlChart" class="font-semibold text-slate-700">Curva de Inventario</h2>
          <div class="text-xs text-slate-500" id="lblActualizado">—</div>
        </div>
        <div class="h-[360px]">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </section>
  </main>

  <footer class="py-8 text-center text-xs text-slate-400">
    v1.2 • PWA • Actualiza en tiempo real
  </footer>

  <!-- ======== APP SCRIPT ======== -->
  <script defer>
/* ========= CONFIG ========= */
const API_BASE = 'https://script.google.com/macros/s/AKfycbxQsD4XJICmZg-5eiZIAEjJ3GZz-GmqvhvMWtiznEOu7SafIKxWopo5iIVy7ufrq_qq/exec';

/* ========= helpers ========= */
const el  = s => document.querySelector(s);
const els = s => Array.from(document.querySelectorAll(s));
const nf = new Intl.NumberFormat('en-US');

const q = el('#q'), btnClearInput = el('#btnClearInput'), suggestions = el('#suggestions');
const btnBuscar = el('#btnBuscar'), btnLimpiar = el('#btnLimpiar');
const lblCodigo=el('#lblCodigo'), lblSuministro=el('#lblSuministro'), lblKBmin=el('#lblKBmin');
const lblCritico=el('#lblCritico'), lblUltInv=el('#lblUltInv'), lblUltFec=el('#lblUltFec');
const lblAct=el('#lblActualizado'), lblProm30=el('#lblProm30'), ttlChartEl=el('#ttlChart');

let chart, searchCtrl=null, itemCtrl=null, deferPrompt=null;

/* ========= INPUT UX ========= */
q.addEventListener('input', () => {
  btnClearInput.classList.toggle('hidden', q.value.trim()==='');
});
btnClearInput.addEventListener('click', () => { q.value=''; btnClearInput.classList.add('hidden'); hideSuggestions(); });

let tDeb=null;
q.addEventListener('input', () => {
  clearTimeout(tDeb);
  const term=q.value.trim();
  if (term.length<2){ hideSuggestions(); return; }
  tDeb=setTimeout(()=>doSearch(term), 250);
});
q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ hideSuggestions(); launchSearch(); }});
btnBuscar.addEventListener('click', launchSearch);
btnLimpiar.addEventListener('click', () => { q.value=''; btnClearInput.classList.add('hidden'); hideSuggestions(); renderItem(null); });

/* ========= SUGERENCIAS ========= */
function showSuggestions(items){
  if(!items || !items.length){ hideSuggestions(); return; }
  items=items.slice(0,10);
  suggestions.innerHTML=items.map(it=>`
    <li class="px-3 py-2 hover:bg-slate-100 border-b border-slate-100" data-cod="${it.codigo||''}">
      <div class="font-medium">${it.suministro||''}</div>
      <div class="text-xs text-slate-500">${it.codigo||''}</div>
    </li>`).join('');
  suggestions.classList.remove('hidden');
  els('#suggestions li').forEach(li=>{
    li.addEventListener('click',()=>{
      const cod=li.getAttribute('data-cod');
      q.value=cod; hideSuggestions(); fetchItem(cod);
    });
  });
}
function hideSuggestions(){ suggestions.classList.add('hidden'); suggestions.innerHTML=''; }

/* ========= BUSCAR ========= */
async function doSearch(term){
  try{
    if (searchCtrl) searchCtrl.abort();
    searchCtrl = new AbortController();

    const url = new URL(API_BASE);
    url.searchParams.set('action','search');
    url.searchParams.set('q', term);

    const res = await fetch(url, { cache:'no-store', signal:searchCtrl.signal });
    const data = await res.json();
    showSuggestions(data.items||[]);
  }catch(e){ if(e.name!=='AbortError') console.error(e); }
}
function setLoading(x){ btnBuscar.disabled=x; btnBuscar.textContent=x?'Buscando…':'Buscar'; }
function launchSearch(){
  const term=q.value.trim();
  if(!term) return;
  if(/^\d{6,}$/.test(term)) fetchItem(term);
  else doSearch(term);
}

/* ========= DETALLE ========= */
async function fetchItem(code){
  try{
    setLoading(true);

    // Cache inmediato
    const cacheKey='item:'+code;
    const cached=localStorage.getItem(cacheKey);
    if(cached) renderItem(JSON.parse(cached), true);

    if(itemCtrl) itemCtrl.abort();
    itemCtrl = new AbortController();

    const url=new URL(API_BASE);
    url.searchParams.set('action','item');
    url.searchParams.set('code', code);

    const res=await fetch(url,{ cache:'no-store', signal:itemCtrl.signal });
    const data=await res.json();

    // Resuelve nombre si faltase
    if(!data.suministro){
      try{
        if(searchCtrl) searchCtrl.abort();
        searchCtrl=new AbortController();
        const s=new URL(API_BASE);
        s.searchParams.set('action','search'); s.searchParams.set('q', code);
        const r=await fetch(s,{cache:'no-store', signal:searchCtrl.signal});
        const sd=await r.json();
        const hit=(sd.items||[]).find(it=>(it.codigo||'')===String(code));
        if(hit?.suministro) data.suministro=hit.suministro;
      }catch(_){}
    }

    localStorage.setItem(cacheKey, JSON.stringify(data));
    renderItem(data);
  }catch(e){
    if(e.name!=='AbortError'){ console.error(e); alert('No se pudo obtener el detalle.'); }
  }finally{ setLoading(false); }
}

/* ========= FECHAS & SERIES ========= */
// Parse robusto: DD/MM/YY(YY) [opcional hora] o ISO
function parseToYMD(str){
  if(!str) return null;
  str=String(str).trim();
  // ISO
  const iso = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(iso) return {y:+iso[1], m:+iso[2], d:+iso[3]};
  // DD/MM/YY[YY] con o sin hora
  const dm = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})/);
  if(dm){
    let d=+dm[1], m=+dm[2], y=+dm[3];
    if(y<100) y+=2000; // 24 => 2024
    return {y, m, d};
  }
  return null;
}
const ymdToKey = o => o ? `${o.y.toString().padStart(4,'0')}-${String(o.m).padStart(2,'0')}-${String(o.d).padStart(2,'0')}` : '';

function groupByDateSum(points){
  const bucket={};
  for(const p of (points||[])){
    const o=parseToYMD(p.fecha);
    if(!o) continue;
    const key=ymdToKey(o);
    const inv=Number(p.inventario||0);
    bucket[key]=(bucket[key]||0)+inv;
  }
  const arr=Object.keys(bucket).sort().map(k=>({ key:k, inventario:bucket[k] }));
  return arr;
}
function sma30(keys, serie){
  // keys son 'YYYY-MM-DD'
  const toDate = k => new Date(k+'T00:00:00Z');
  const dts = keys.map(toDate);
  return keys.map((_,i)=>{
    const to=dts[i], from=new Date(to); from.setUTCDate(from.getUTCDate()-29);
    let sum=0, cnt=0;
    for(let k=i;k>=0 && dts[k]>=from;k--){ sum+=Number(serie[k]||0); cnt++; }
    return cnt? sum/cnt : null;
  });
}
const prettyDMY = key => { const [y,m,d]=key.split('-'); return `${d}/${m}/${y}`; };

/* ========= RENDER ========= */
function renderItem(data, fromCache=false){
  // Reset
  if(!data){
    [lblCodigo,lblSuministro,lblKBmin,lblCritico,lblUltInv,lblUltFec,lblProm30,lblAct]
      .forEach(l=>l.textContent='—');
    ttlChartEl.textContent='Curva de Inventario';
    if(chart) chart.destroy();
    return;
  }

  // 1) Consolidar
  const puntosRaw = Array.isArray(data.puntos)? data.puntos : [];
  const puntos = groupByDateSum(puntosRaw);

  // 2) Series
  const labels = puntos.map(p=>p.key); // YYYY-MM-DD
  const inv    = puntos.map(p=>Number(p.inventario||0));
  const avg30  = sma30(labels, inv);
  const lastIx = labels.length? labels.length-1 : -1;

  // 3) Panel
  lblCodigo.textContent     = data.codigo || '—';
  lblSuministro.textContent = data.suministro || '—';
  lblKBmin.textContent      = (data.kb_min != null ? nf.format(+data.kb_min) : '—');
  lblCritico.textContent    = (data.critico != null ? nf.format(+data.critico) : '—');
  lblUltInv.textContent     = (lastIx>=0 ? nf.format(inv[lastIx]||0) : '—');
  lblUltFec.textContent     = (lastIx>=0 ? prettyDMY(labels[lastIx]) : '—');
  lblProm30.textContent     = (lastIx>=0 && avg30[lastIx]!=null ? nf.format(avg30[lastIx]) : '—');
  lblAct.textContent        = (fromCache?'(caché) ':'') + new Date().toLocaleString();
  ttlChartEl.textContent    = `${data.codigo || '—'} — ${data.suministro || '—'}`;

  // 4) Datasets
  const datasets = [
    { label:'Inventario', data: inv,
      borderColor:'rgba(59,130,246,1)', backgroundColor:'rgba(59,130,246,.15)',
      pointRadius:2, borderWidth:2, tension:.2, fill:'origin', clip:false },
    { label:'Promedio 30 días', data: avg30,
      borderColor:'rgba(100,116,139,1)', backgroundColor:'rgba(100,116,139,.08)',
      pointRadius:0, borderWidth:2, borderDash:[6,4], tension:.2, fill:false, clip:false }
  ];
  if(Number.isFinite(+data.kb_min)){
    datasets.push({ label:'KB_min', data: labels.map(()=>+data.kb_min),
      borderColor:'rgba(234,179,8,1)', backgroundColor:'rgba(234,179,8,.10)',
      pointRadius:0, borderWidth:1, fill:false, clip:false });
  }
  if(Number.isFinite(+data.critico)){
    datasets.push({ label:'Crítico', data: labels.map(()=>+data.critico),
      borderColor:'rgba(239,68,68,1)', backgroundColor:'rgba(239,68,68,.10)',
      pointRadius:0, borderWidth:1, fill:false, clip:false });
  }

  // Plugin: rotula último valor
  const lastValuePlugin = {
    id:'lastValuePlugin',
    afterDatasetsDraw(c){
      const {ctx}=c; ctx.save(); ctx.font='12px sans-serif'; ctx.textBaseline='middle';
      c.data.datasets.forEach((ds,i)=>{
        const meta=c.getDatasetMeta(i); if(!meta?.data?.length) return;
        let idx=ds.data.length-1; while(idx>=0 && (ds.data[idx]==null || !isFinite(ds.data[idx]))) idx--;
        if(idx<0) return; const pt=meta.data[idx]; const val=+ds.data[idx];
        ctx.fillStyle = Array.isArray(ds.borderColor)? ds.borderColor[0] : (ds.borderColor||'#334155');
        ctx.fillText(nf.format(val), pt.x+6, pt.y);
      });
      ctx.restore();
    }
  };

  // Ticks del eje X: último siempre + 1ro de cada mes
  function xTickCallback(value, index, ticks){
    const isLast = index === ticks.length-1;
    if(isLast) return prettyDMY(labels[index]);
    const [y,m,] = String(labels[index]||'').split('-');
    const prev = index>0 ? String(labels[index-1]).split('-') : null;
    const changedMonth = !prev || (prev[0]!==y || prev[1]!==m);
    return changedMonth ? prettyDMY(labels[index]) : '';
  }

  // Render
  if(chart) chart.destroy();
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels: labels.map(prettyDMY), datasets },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{ intersect:false, mode:'index' },
      layout:{ padding:{ right:60 } },
      plugins:{ legend:{ position:'top' },
        tooltip:{ callbacks:{ label(c){ return `${c.dataset.label}: ${nf.format(c.parsed.y)}`; } } } },
      scales:{
        x:{ ticks:{ autoSkip:false, maxRotation:0, minRotation:0, callback:(v,i,t)=>xTickCallback(v,i,t) } },
        y:{ beginAtZero:false }
      }
    },
    plugins:[lastValuePlugin]
  });
}

/* ========= PWA ========= */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(console.error); });
}
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferPrompt=e; el('#btnInstall')?.classList.remove('hidden');
});
el('#btnInstall')?.addEventListener('click', async ()=>{
  if(!deferPrompt) return; deferPrompt.prompt(); await deferPrompt.userChoice;
  deferPrompt=null; el('#btnInstall')?.classList.add('hidden');
});
  </script>
</body>
</html>