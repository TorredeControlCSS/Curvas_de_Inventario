<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario CEDIS — Curvas en tiempo real</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">

  <!-- Ícono (más rápido que base64) -->
  <link rel="apple-touch-icon" href="icons/icon-192.png">

  <!-- UI (Tailwind CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <style>
    .card{ box-shadow:0 6px 24px rgba(0,0,0,.08), 0 2px 6px rgba(0,0,0,.04); }
    #suggestions li{ cursor:pointer }
    .disabled{ opacity:.5; pointer-events:none }
    .empty-msg{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-size:.9rem }
  </style>
</head>
<body class="bg-white text-slate-800 min-h-screen">
  <!-- HEADER -->
  <header class="bg-sky-600 text-white">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="icons/icon-192.png" alt="DINALOG - CSS Panamá"
             class="h-10 sm:h-12 md:h-14 w-auto mr-1 select-none" loading="eager" decoding="async"/>
        <h1 class="text-lg sm:text-2xl font-semibold">CEDIS Panama – Curvas de Inventario</h1>
      </div>
      <button id="btnInstall" class="hidden bg-white/10 hover:bg-white/20 px-3 py-1 rounded">Instalar</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- BUSCADOR -->
    <section class="card bg-white rounded-2xl p-4">
      <div class="flex flex-col gap-3">
        <label class="text-sm text-slate-500">
          Busca por <b>código</b> o <b>nombre de suministro</b>
        </label>

        <div class="relative">
          <input id="q" type="search" placeholder="Ej.: 101098001 o amlodipina"
                 class="w-full rounded-xl border border-slate-300 px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-sky-500">
          <button id="btnClearInput" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 text-xl hidden" aria-label="Limpiar">×</button>
          <ul id="suggestions" class="absolute z-10 mt-1 w-full bg-white border border-slate-200 rounded-xl max-h-64 overflow-auto hidden"></ul>
        </div>

        <div class="flex gap-2">
          <button id="btnBuscar" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-xl">Buscar</button>
          <button id="btnLimpiar" class="bg-slate-100 hover:bg-slate-200 px-4 py-2 rounded-xl">Limpiar</button>
        </div>
      </div>
    </section>

    <!-- PANEL DATOS + GRÁFICO -->
    <section class="grid md:grid-cols-3 gap-4">
      <!-- DETALLE -->
      <div class="card bg-white rounded-2xl p-4 md:col-span-1 space-y-3">
        <h2 class="font-semibold text-slate-700">Detalle</h2>
        <div class="text-sm space-y-1">
          <div><span class="text-slate-500">Código:</span> <span id="lblCodigo" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Suministro:</span> <span id="lblSuministro">—</span></div>
          <div><span class="text-slate-500">KB_min:</span> <span id="lblKBmin" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Crítico:</span> <span id="lblCritico" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Promedio 30 días:</span> <span id="lblProm30" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Último inventario:</span> <span id="lblUltInv" class="font-mono">—</span></div>
          <div><span class="text-slate-500">Fecha último:</span> <span id="lblUltFec" class="font-mono">—</span></div>
          <div class="text-xs text-slate-500 pt-2">Fuente: API Inventario CEDIS (Apps Script)</div>
        </div>
      </div>

      <!-- GRÁFICO -->
      <div class="card bg-white rounded-2xl p-4 md:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <h2 id="ttlChart" class="font-semibold text-slate-700">Curva de Inventario</h2>
          <div class="text-xs text-slate-500" id="lblActualizado">—</div>
        </div>
        <div class="h-[360px] relative">
          <div id="empty" class="empty-msg hidden">Sin datos para graficar</div>
          <canvas id="chart"></canvas>
        </div>
      </div>
    </section>
  </main>

  <footer class="py-8 text-center text-xs text-slate-400">
    v1.2 • PWA • Actualiza en tiempo real
  </footer>

  <!-- ======== APP SCRIPT ======== -->
<script>
/* ========= CONFIG ========= */
const API_BASE = 'https://script.google.com/macros/s/AKfycbxQsD4XJICmZg-5eiZIAEjJ3GZz-GmqvhvMWtiznEOu7SafIKxWopo5iIVy7ufrq_qq/exec';
const CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutos

/* ========= Estado & helpers ========= */
const el  = s => document.querySelector(s);
const els = s => Array.from(document.querySelectorAll(s));

const q              = el('#q');
const btnClearInput  = el('#btnClearInput');
const suggestions    = el('#suggestions');
const btnBuscar      = el('#btnBuscar');
const btnLimpiar     = el('#btnLimpiar');

const lblCodigo   = el('#lblCodigo');
const lblSuministro = el('#lblSuministro');
const lblKBmin    = el('#lblKBmin');
const lblCritico  = el('#lblCritico');
const lblUltInv   = el('#lblUltInv');
const lblUltFec   = el('#lblUltFec');
const lblAct      = el('#lblActualizado');
const lblProm30   = el('#lblProm30');
const ttlChartEl  = el('#ttlChart');
const emptyMsg    = el('#empty');

let deferPrompt; // PWA install event
let chart;
const nf = new Intl.NumberFormat('es-PA');
const df = new Intl.DateTimeFormat('es-PA', {day:'2-digit', month:'2-digit', year:'numeric'});

/* ========= Caché con TTL ========= */
function cacheSet(key, value){
  const payload = {t: Date.now(), v: value};
  localStorage.setItem(key, JSON.stringify(payload));
}
function cacheGet(key){
  const raw = localStorage.getItem(key);
  if (!raw) return null;
  try{
    const {t, v} = JSON.parse(raw);
    if (Date.now() - t > CACHE_TTL_MS) return null;
    return v;
  }catch{ return null; }
}

/* ========= INPUT UX ========= */
q.addEventListener('input', () => {
  btnClearInput?.classList.toggle('hidden', q.value.trim()==='');
});
btnClearInput?.addEventListener('click', () => {
  q.value=''; btnClearInput.classList.add('hidden'); hideSuggestions();
});

let tDeb = null;
q.addEventListener('input', () => {
  clearTimeout(tDeb);
  const term = q.value.trim();
  if (term.length < 2) { hideSuggestions(); return; }
  tDeb = setTimeout(() => doSearch(term), 250);
});

q.addEventListener('keydown', (ev) => {
  if (ev.key === 'Enter') { hideSuggestions(); launchSearch(); }
});

btnBuscar.addEventListener('click', launchSearch);
btnLimpiar.addEventListener('click', () => {
  q.value = '';
  btnClearInput?.classList.add('hidden');
  hideSuggestions();
  renderItem(null);
});

/* ========= Sugerencias ========= */
function showSuggestions(items){
  if (!items || !items.length) { hideSuggestions(); return; }
  items = items.slice(0, 10);
  suggestions.innerHTML = items.map(it => (
    `<li class="px-3 py-2 hover:bg-slate-100 border-b border-slate-100" data-cod="${it.codigo}">
       <div class="font-medium">${it.suministro || ''}</div>
       <div class="text-xs text-slate-500">${it.codigo || ''}</div>
     </li>`
  )).join('');
  suggestions.classList.remove('hidden');
  els('#suggestions li').forEach(li => {
    li.addEventListener('click', () => {
      const cod = li.getAttribute('data-cod');
      q.value = cod;
      hideSuggestions();
      fetchItem(cod);
    });
  });
}
function hideSuggestions(){ suggestions.classList.add('hidden'); suggestions.innerHTML=''; }

/* ========= Buscador con cancelación ========= */
let searchCtrl = null, itemCtrl = null;

async function doSearch(term){
  try{
    // caché
    const cKey = 'search:' + term.toLowerCase();
    const cVal = cacheGet(cKey);
    if (cVal) { showSuggestions(cVal.items || []); return; }

    if (searchCtrl) searchCtrl.abort();
    searchCtrl = new AbortController();

    const url = new URL(API_BASE);
    url.searchParams.set('action','search');
    url.searchParams.set('q', term);

    const res = await fetch(url, {cache:'no-store', signal: searchCtrl.signal});
    const data = await res.json();
    cacheSet(cKey, data);
    showSuggestions(data.items || []);
  }catch(e){
    if (e.name !== 'AbortError') console.error('search error', e);
  }
}

function setLoading(isLoading){
  btnBuscar.disabled = isLoading;
  btnBuscar.textContent = isLoading ? 'Buscando…' : 'Buscar';
}

function launchSearch(){
  const term = q.value.trim();
  if (!term) return;
  if (/^\d{6,}$/.test(term)) fetchItem(term);
  else doSearch(term);
}

/* ========= Adaptador de payloads ========= */
function pickItemShape(raw){
  // Acepta {codigo, suministro, kb_min, critico, puntos:[{fecha, inventario}]}
  // o estructuras anidadas comunes: {item:{...}}, {data:{...}}
  const v = raw?.item || raw?.data || raw || {};
  return {
    codigo:    v.codigo ?? v.code ?? '',
    suministro:v.suministro ?? v.name ?? v.descripcion ?? '',
    kb_min:    v.kb_min ?? v.kbmin ?? v.kb ?? null,
    critico:   v.critico ?? v.critical ?? null,
    puntos:    Array.isArray(v.puntos) ? v.puntos
              : Array.isArray(v.series) ? v.series
              : []
  };
}

/* ========= Item con cache + cancelación ========= */
async function fetchItem(code){
  try{
    setLoading(true);

    const cKey = 'item:' + code;
    const cVal = cacheGet(cKey);
    if (cVal) renderItem(pickItemShape(cVal), true);

    if (itemCtrl) itemCtrl.abort();
    itemCtrl = new AbortController();

    const url = new URL(API_BASE);
    url.searchParams.set('action','item');
    url.searchParams.set('code', code);
    const res = await fetch(url, {cache:'no-store', signal: itemCtrl.signal});
    const data = await res.json();

    cacheSet(cKey, data);
    renderItem(pickItemShape(data));
  }catch(e){
    if (e.name !== 'AbortError') {
      console.error('item error', e);
      alert('No se pudo obtener el detalle. Revisa la conexión o el código.');
    }
  } finally {
    setLoading(false);
  }
}

/* ========= Utilitarios de FECHA ========= */
// Convierte "DD/MM/AAAA" (o "D/M/AA") a Date sin ambigüedad
function parseDMY(s){
  if (!s) return null;
  if (s instanceof Date) return s;
  const str = String(s).trim();
  const m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if (m){
    let d = +m[1], mo = +m[2]-1, y = +m[3];
    if (y < 100) y += 2000; // por si vienen '24'
    const dt = new Date(Date.UTC(y, mo, d));
    return dt;
  }
  // intento final: ISO
  const iso = new Date(str);
  return isNaN(+iso) ? null : iso;
}

function fmtDate(d){
  try { return df.format(d); } catch { return String(d); }
}

/* ========= Curado de datos ========= */
// Agrupa por fecha (día) sumando inventario y limpia outliers de año raro (<2019)
function groupByDateSum(points){
  const bucket = {};
  for (const p of (points||[])) {
    const dt = parseDMY(p.fecha);
    if (!dt) continue;
    const y = dt.getUTCFullYear();
    if (y < 2019) continue; // evita 1907/1937 causados por parseos malos de origen
    const key = fmtDate(dt); // etiqueta final dd/mm/aaaa
    const inv = Number(p.inventario || 0);
    bucket[key] = (bucket[key] || 0) + inv;
  }
  const entries = Object.entries(bucket)
    .map(([fecha, inventario]) => ({fecha, inventario}))
    .sort((a,b)=>{
      const [ad,am,ay] = a.fecha.split('/').map(Number);
      const [bd,bm,by] = b.fecha.split('/').map(Number);
      return new Date(by,bm-1,bd) - new Date(ay,am-1,ad) < 0 ? -1 : 1;
    });
  return entries;
}

// SMA 30 días hasta cada fecha (promedio móvil simple)
function sma30(labels, serie){
  // labels ya están como "dd/mm/aaaa"
  const toDate = s => {
    const [d,m,y] = s.split('/').map(Number);
    return new Date(Date.UTC(y, m-1, d));
  };
  const dts = labels.map(toDate);
  return labels.map((_, i) => {
    const to = dts[i];
    const from = new Date(to); from.setUTCDate(from.getUTCDate()-29);
    let sum=0, cnt=0;
    for (let k=i; k>=0 && dts[k]>=from; k--) { sum += Number(serie[k]||0); cnt++; }
    return cnt ? sum/cnt : null;
  });
}

/* ========= Render ========= */
function renderItem(data, fromCache=false){
  // Reset
  if (!data) {
    lblCodigo.textContent = '—';
    lblSuministro.textContent = '—';
    lblKBmin.textContent = '—';
    lblCritico.textContent = '—';
    lblUltInv.textContent = '—';
    lblUltFec.textContent = '—';
    lblProm30.textContent = '—';
    lblAct.textContent = '—';
    ttlChartEl.textContent = 'Curva de Inventario';
    emptyMsg.classList.add('hidden');
    if (chart) chart.destroy();
    return;
  }

  // 1) Consolidar por día y ordenar
  const puntos = groupByDateSum(data.puntos);

  // 2) Series
  const labels = puntos.map(p=>p.fecha);
  const inv    = puntos.map(p=>Number(p.inventario||0));
  const avg30  = sma30(labels, inv);

  // Últimos
  const lastInv = inv.length ? inv[inv.length-1] : null;
  const lastLbl = labels.length ? labels[labels.length-1] : null;
  const lastAvg = avg30.length ? avg30[avg30.length-1] : null;

  // 3) Panel
  lblCodigo.textContent     = data.codigo || '—';
  lblSuministro.textContent = data.suministro || '—';
  lblKBmin.textContent      = (data.kb_min != null ? nf.format(+data.kb_min) : '—');
  lblCritico.textContent    = (data.critico != null ? nf.format(+data.critico) : '—');
  lblUltInv.textContent     = (lastInv != null ? nf.format(lastInv) : '—');
  lblUltFec.textContent     = (lastLbl || '—');
  lblProm30.textContent     = (lastAvg != null ? nf.format(lastAvg) : '—');
  lblAct.textContent        = (fromCache?'(caché) ':'') + new Date().toLocaleString();
  ttlChartEl.textContent    = `${data.codigo || '—'} — ${data.suministro || '—'}`;

  // 4) Si no hay puntos válidos, mensaje y gráfico vacío
  if (!labels.length){
    if (chart) chart.destroy();
    emptyMsg.classList.remove('hidden');
    return;
  } else {
    emptyMsg.classList.add('hidden');
  }

  // Datasets
  const datasets = [
    {
      label:'Inventario',
      data: inv,
      borderColor: 'rgba(59,130,246,1)',
      backgroundColor: 'rgba(59,130,246,0.15)',
      pointRadius: 2,
      borderWidth: 2,
      tension: .2,
      fill: 'origin',
      clip: false
    },
    {
      label: 'Promedio 30 días',
      data: avg30,
      borderColor: 'rgba(100,116,139,1)',
      backgroundColor: 'rgba(100,116,139,0.08)',
      pointRadius: 0,
      borderWidth: 2,
      borderDash: [6,4],
      tension: .2,
      fill: false,
      clip: false
    }
  ];
  if (Number.isFinite(+data.kb_min)) {
    datasets.push({
      label:'KB_min',
      data: labels.map(()=> +data.kb_min),
      borderColor: 'rgba(234,179,8,1)',
      backgroundColor: 'rgba(234,179,8,0.10)',
      pointRadius:0,
      borderWidth:1,
      fill: false,
      clip: false
    });
  }
  if (Number.isFinite(+data.critico)) {
    datasets.push({
      label:'Crítico',
      data: labels.map(()=> +data.critico),
      borderColor: 'rgba(239,68,68,1)',
      backgroundColor: 'rgba(239,68,68,0.10)',
      pointRadius:0,
      borderWidth:1,
      fill: false,
      clip: false
    });
  }

  // Plugin: rotula último valor a la derecha
  const lastValuePlugin = {
    id: 'lastValuePlugin',
    afterDatasetsDraw(chart, args) {
      const {ctx} = chart;
      ctx.save(); ctx.font = '12px sans-serif'; ctx.textBaseline = 'middle';
      chart.data.datasets.forEach((ds, i) => {
        const meta = chart.getDatasetMeta(i);
        if (!meta?.data?.length) return;
        let idx = ds.data.length-1;
        while (idx>=0 && (ds.data[idx]==null || !isFinite(ds.data[idx]))) idx--;
        if (idx<0) return;
        const pt = meta.data[idx];
        const val = +ds.data[idx];
        if (!pt || !isFinite(val)) return;
        const x = pt.x + 6, y = pt.y;
        ctx.fillStyle = Array.isArray(ds.borderColor) ? ds.borderColor[0] : (ds.borderColor || '#334155');
        ctx.fillText(nf.format(val), x, y);
      });
      ctx.restore();
    }
  };

  // Eje X: quincenal + último
  function xTickCallback(value, index, ticks){
    const isLast = index === (ticks.length-1);
    if (isLast) return labels[index];
    // mostrar cada 14 días aproximados respecto al primero
    const [d0,m0,y0] = labels[0].split('/').map(Number);
    const [di,mi,yi] = labels[index].split('/').map(Number);
    const t0 = Date.UTC(y0,m0-1,d0);
    const ti = Date.UTC(yi,mi-1,di);
    const diffDays = Math.round((ti - t0)/(1000*60*60*24));
    return (diffDays % 14 === 0) ? labels[index] : '';
  }

  if (chart) chart.destroy();
  const ctx = document.getElementById('chart').getContext('2d');
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{ intersect:false, mode:'index' },
      layout:{ padding: { right: 60 } },
      plugins:{
        legend:{ position:'top' },
        tooltip:{ callbacks:{ label(c){ return `${c.dataset.label}: ${nf.format(c.parsed.y)}`; } } }
      },
      scales: {
        x: {
          ticks: { autoSkip:false, maxRotation:0, minRotation:0, callback: xTickCallback },
          grid: { display:true }
        },
        y: { beginAtZero:false }
      }
    },
    plugins:[lastValuePlugin]
  });
}

/* ========= PWA / Service Worker ========= */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault(); deferPrompt = e;
  el('#btnInstall')?.classList.remove('hidden');
});
el('#btnInstall')?.addEventListener('click', async () => {
  if (!deferPrompt) return;
  deferPrompt.prompt(); await deferPrompt.userChoice;
  deferPrompt = null; el('#btnInstall')?.classList.add('hidden');
});
</script>
</body>
</html>