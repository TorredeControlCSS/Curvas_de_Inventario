<!doctype html>
<html lang="es" data-theme="system">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Curvas de Inventario</title>
  <link rel="icon" href="icons/icon-192.png">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b1f3a; --bg2:#133a74; --card:#ffffff; --muted:#6b7280; --ring:#e5e7eb;
      --text:#0f172a; --sub:#334155; --chip:#eef2ff; --chipText:#1e40af;
      --border:#e5e7eb; --canvas:#f6f7fb;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0a1120; --bg2:#0f2142; --card:#0f172a; --muted:#94a3b8; --ring:#1f2937;
        --text:#e5e7eb; --sub:#cbd5e1; --chip:#0b2b5f; --chipText:#bfdbfe;
        --border:#334155; --canvas:#0b1220;
      }
    }
    [data-theme="dark"]{
      --bg:#0a1120; --bg2:#0f2142; --card:#0f172a; --muted:#94a3b8; --ring:#1f2937;
      --text:#e5e7eb; --sub:#cbd5e1; --chip:#0b2b5f; --chipText:#bfdbfe;
      --border:#334155; --canvas:#0b1220;
    }
    [data-theme="light"]{
      --bg:#0b1f3a; --bg2:#133a74; --card:#ffffff; --muted:#6b7280; --ring:#e5e7eb;
      --text:#0f172a; --sub:#334155; --chip:#eef2ff; --chipText:#1e40af;
      --border:#e5e7eb; --canvas:#f6f7fb;
    }

    *{box-sizing:border-box}
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, sans-serif; margin:0; background:var(--canvas); color:var(--text);}
    .topbar{
      background: linear-gradient(90deg, var(--bg), var(--bg2));
      color:#fff; padding:12px 14px; display:flex; align-items:center; gap:12px;
      box-shadow: 0 2px 10px rgba(0,0,0,.2); position:sticky; top:0; z-index:10;
    }
    .topbar img{width:36px; height:36px; border-radius:8px}
    .title{font-size:16px; font-weight:700; letter-spacing:.3px; flex:1}
    .top-actions{display:flex; gap:8px; align-items:center}
    .btn{padding:8px 10px; border:1px solid var(--ring); border-radius:10px; background:#fff; color:#0f172a; cursor:pointer; font-weight:600}
    .btn.ghost{background:transparent; color:#fff; border-color:rgba(255,255,255,.25)}
    .btn.install{background:#00b894; color:#fff; border-color:#00b894}
    .theme-select{padding:6px 8px; border:1px solid rgba(255,255,255,.25); border-radius:10px; background:transparent; color:#fff}

    .container{padding:14px; max-width:1400px; margin:0 auto;}
    /* Filtros responsivos */
    .filters{display:grid; grid-template-columns: 120px 1fr 1fr 1fr 140px 140px 130px 120px; gap:8px; align-items:end; margin-bottom:12px;}
    @media (max-width: 1024px){
      .filters{grid-template-columns: 1fr 1fr; }
    }
    @media (max-width: 640px){
      .filters{grid-template-columns: 1fr; }
    }
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px;}
    label{font-size:12px; color:var(--sub);}
    select,input,button{width:100%; padding:8px 10px; border:1px solid var(--ring); border-radius:10px; background:#fff; color:#0f172a;}
    [data-theme="dark"] select,[data-theme="dark"] input{ background:#0b1324; color:#e5e7eb; border-color:#334155; }
    button.primary{background:#0b5fff; color:#fff; border-color:#0b5fff; font-weight:700}
    button.ghost{background:#fff}
    .row{display:grid; grid-template-columns: 2fr 1fr; gap:12px;}
    @media (max-width: 1024px){ .row{grid-template-columns: 1fr;} }
    .chart-wrap{height:420px;}
    .table-wrap{max-height:420px; overflow:auto}
    table{width:100%; border-collapse:collapse; font-size:12px;}
    th,td{border-bottom:1px solid var(--ring); padding:8px 10px; text-align:left; white-space:nowrap;}
    thead th{position:sticky; top:0; background:var(--card); z-index:1;}
    .muted{color:var(--muted); font-size:12px}
    .kpis{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:10px; margin-top:8px; margin-bottom:12px;}
    .kpi{background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px}
    .kpi .v{font-size:20px; font-weight:800}
    .kpi .l{font-size:12px; color:var(--sub)}
    .side{display:grid; gap:10px; align-content:start}
    .metric{display:flex; justify-content:space-between; font-weight:700}
    .metric small{color:var(--muted); font-weight:500}
    .hidden{display:none !important;}
  </style>
</head>
<body>
  <div class="topbar">
    <img id="logo" src="icons/icon-192.png" alt="Logo">
    <div class="title">Curvas de Inventario — CEDIS Panamá</div>
    <div class="top-actions">
      <select id="theme" class="theme-select" title="Tema">
        <option value="system">Sistema</option>
        <option value="light">Claro</option>
        <option value="dark">Oscuro</option>
      </select>
      <button id="installBtn" class="btn install hidden">Instalar app</button>
      <button id="refreshBtn" class="btn ghost">Actualizar</button>
    </div>
  </div>

  <div class="container">
    <div class="card filters">
      <div>
        <label>Buscar por</label>
        <select id="mode">
          <option>Código</option>
          <option selected>Suministro</option>
          <option>Grupo</option>
        </select>
      </div>
      <div id="termWrap">
        <label id="lbl-term">Suministro</label>
        <!-- TYPEAHEAD: input + datalist -->
        <input id="term" list="termOptions" placeholder="Escribe para buscar..." autocomplete="off">
        <datalist id="termOptions"></datalist>
      </div>
      <div>
        <label>Grupo</label>
        <select id="group"><option value="">Todos</option></select>
      </div>
      <div>
        <label>Pedido (+45d)</label>
        <input id="qty" type="number" min="0" step="100" value="0" />
      </div>
      <div>
        <label>Desde</label>
        <input id="from" type="date" />
      </div>
      <div>
        <label>Hasta</label>
        <input id="to" type="date" />
      </div>
      <div>
        <button id="btn" class="primary">Mostrar</button>
      </div>
      <div>
        <button id="btnClear" class="ghost">Limpiar</button>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="l">Inventario actual</div><div class="v" id="kpiInv">–</div></div>
      <div class="kpi"><div class="l">KB_min (reorden)</div><div class="v" id="kpiKb">–</div></div>
      <div class="kpi"><div class="l">Inv. Crítico (95%)</div><div class="v" id="kpiCrit">–</div></div>
    </div>

    <div class="row">
      <div class="card chart-wrap">
        <canvas id="chart"></canvas>
      </div>
      <div class="side">
        <div class="card">
          <div class="muted">Indicadores de la serie</div>
          <div class="metric"><span>Mínimo histórico</span><span id="mMin">–</span></div>
          <small id="mMinDate" class="muted"></small>
          <div class="metric"><span>Máximo histórico</span><span id="mMax">–</span></div>
          <small id="mMaxDate" class="muted"></small>
          <div class="metric"><span>Promedio 30 días</span><span id="mAvg30">–</span></div>
        </div>
        <div class="card table-wrap">
          <div class="muted">Tabla diaria</div>
          <table id="tbl"><thead><tr><th>Fecha</th><th>Cantidad</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </div>

<script>
// === CONFIG ===
const API_BASE = 'https://script.google.com/macros/s/AKfycbyvmMSLIwNNAZSr_CffgH_LGTw6xFPqZ4H2tjQdVZnlTP0_bgFgvasLqPTElBUHSPkdOA/exec';
const LEAD = 45;
const TYPEAHEAD_LIMIT = 100;

let chartInstance = null;
let deferredPrompt = null;
let codes = [], sups = [], groups = [];

const fmtInt = (n)=> Number(n||0).toLocaleString();
const $ = (id)=> document.getElementById(id);

// ---- Theme ----
(function initTheme(){
  const saved = localStorage.getItem('theme') || 'system';
  document.documentElement.setAttribute('data-theme', saved);
  $('theme').value = saved;
  $('theme').addEventListener('change', (e)=>{
    const val = e.target.value;
    localStorage.setItem('theme', val);
    document.documentElement.setAttribute('data-theme', val);
  });
})();

// ---- PWA install button ----
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  $('installBtn').classList.remove('hidden');
});
$('installBtn').addEventListener('click', async ()=>{
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  $('installBtn').classList.add('hidden');
  deferredPrompt = null;
});
window.addEventListener('appinstalled', ()=>{
  $('installBtn').classList.add('hidden');
});

async function fetchJSON(url){
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error("HTTP " + r.status + " al solicitar " + url);
  return r.json();
}

// Cache ligero de /list en localStorage
async function fetchList(){
  const KEY = 'inv_meta_v3';
  const now = Date.now();
  try {
    const raw = localStorage.getItem(KEY);
    if (raw){
      const cached = JSON.parse(raw);
      if (now - cached.t < 10*60*1000) { // 10 minutos
        return cached.data;
      }
    }
  } catch(_) {}
  const data = await fetchJSON(API_BASE + '?list=true');
  try { localStorage.setItem(KEY, JSON.stringify({t: now, data})); } catch(_) {}
  return data;
}
async function fetchSerie(params){
  const p = new URLSearchParams(params);
  return fetchJSON(API_BASE + '?' + p.toString());
}

// === TYPEAHEAD ===
function fillDatalist(arr, q=''){
  const dl = $('termOptions');
  const normQ = q.trim().toLowerCase();
  let suggestions = [];
  if (!normQ){
    suggestions = arr.slice(0, TYPEAHEAD_LIMIT);
  } else {
    // prioriza prefijo; luego contiene
    const starts = arr.filter(v => v.toLowerCase().startsWith(normQ));
    const contains = arr.filter(v => !v.toLowerCase().startsWith(normQ) && v.toLowerCase().includes(normQ));
    suggestions = starts.concat(contains).slice(0, TYPEAHEAD_LIMIT);
  }
  dl.innerHTML = suggestions.map(v => `<option value="${v}"></option>`).join('');
}

function ses(cons, H, alpha=0.3){
  if (!cons.length) return Array(H).fill(0);
  let s = cons[0];
  for (let i=1;i<cons.length;i++){ s = alpha*cons[i] + (1-alpha)*s; }
  return Array(H).fill(s);
}

function simulate(invLast, dHat, q=0, lead=LEAD){
  const H = dHat.length;
  const base = new Array(H);
  const withOrder = new Array(H);
  for (let h=0; h<H; h++){
    if (h===0) base[h] = Math.max(invLast - dHat[h], 0);
    else base[h] = Math.max(base[h-1] - dHat[h], 0);
  }
  withOrder[0] = Math.max(invLast - dHat[0], 0);
  for (let h=1; h<H; h++){ withOrder[h] = Math.max(withOrder[h-1] - dHat[h], 0); }
  const idx = lead-1;
  if (idx>=0 && idx<H){
    withOrder[idx] += Number(q||0);
    for (let h=idx+1; h<H; h++){ withOrder[h] = Math.max(withOrder[h-1] - dHat[h], 0); }
  }
  return {base, withOrder};
}

function fillTable(tbody, serie){
  tbody.innerHTML='';
  for (const p of serie){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.fecha}</td><td>${fmtInt(p.inventario)}</td>`;
    tbody.appendChild(tr);
  }
}

function setKPIs(invLast, kb, sfty){
  $('kpiInv').textContent = fmtInt(invLast);
  $('kpiKb').textContent = fmtInt(kb);
  $('kpiCrit').textContent = fmtInt(sfty);
}

function setSideMetrics(minV, minD, maxV, maxD, avg30){
  $('mMin').textContent = fmtInt(minV);
  $('mMinDate').textContent = minD ? `en ${minD}` : '';
  $('mMax').textContent = fmtInt(maxV);
  $('mMaxDate').textContent = maxD ? `en ${maxD}` : '';
  $('mAvg30').textContent = fmtInt(avg30);
}

async function init(){
  const modeSel = $('mode');
  const termInp = $('term');
  const lbl = $('lbl-term');
  const termWrap = $('termWrap');
  const groupSel = $('group');
  const qty = $('qty');
  const from = $('from');
  const to = $('to');
  const btn = $('btn');
  const btnClear = $('btnClear');
  const refreshBtn = $('refreshBtn');
  const tbody = document.querySelector('#tbl tbody');
  const ctx = $('chart').getContext('2d');

  // listas
  const meta = await fetchList();
  codes = meta.codigos || [];
  sups  = meta.suministros || [];
  groups = [''].concat(meta.grupos || []);
  groupSel.innerHTML = groups.map(g => `<option value="${g}">${g||'Todos'}</option>`).join('');
  from.value = meta.min_fecha || ''; to.value = meta.max_fecha || '';

  function fillTerms(){
    const mode = modeSel.value;
    if (mode==='Código'){
      lbl.textContent = 'Código';
      termWrap.classList.remove('hidden');
      termInp.value = '';
      fillDatalist(codes);
    } else if (mode==='Suministro'){
      lbl.textContent = 'Suministro';
      termWrap.classList.remove('hidden');
      termInp.value = '';
      fillDatalist(sups);
    } else { // Grupo
      termWrap.classList.add('hidden');
      termInp.value = '';
    }
  }
  modeSel.addEventListener('change', fillTerms);
  termInp.addEventListener('input', (e)=>{
    const mode = modeSel.value;
    const arr = (mode==='Código') ? codes : sups;
    fillDatalist(arr, e.target.value || '');
  });

  // Forzar modo inicial = Suministro, autoselect primera opción (sin llenar miles de opciones)
  modeSel.value = 'Suministro';
  fillTerms();
  if (sups.length > 0) {
    termInp.value = sups[0];
  }

  async function run(){
    const mode = modeSel.value;
    const group = groupSel.value;
    const Q = Number(qty.value||0);
    const fromV = from.value, toV = to.value;

    const params = {};
    if (mode==='Código') params.codigo = termInp.value;
    if (mode==='Suministro') params.suministro = termInp.value;
    if (group && mode!=='Grupo') params.grupo = group; // filtro adicional
    if (mode==='Grupo') params.grupo = group;
    if (fromV) params.from = fromV;
    if (toV) params.to = toV;

    const data = await fetchSerie(params);
    const serie = data.serie || [];
    if (!serie.length){ alert('Sin datos para esa selección/filtro.'); return; }

    const invHist = serie.map(p=>Number(p.inventario));
    const cons=[]; for(let i=1;i<invHist.length;i++){ cons.push(Math.max(invHist[i-1]-invHist[i],0)); }
    const dHat = ses(cons, 45, 0.3);
    const invLast = invHist[invHist.length-1];
    const {base, withOrder} = simulate(invLast, dHat, Q, data.lead||LEAD);

    const lastDate = new Date(serie[serie.length-1].fecha);
    const future = [];
    for(let i=1;i<=45;i++){
      const d=new Date(lastDate);
      d.setDate(d.getDate()+i);
      future.push(d.toISOString().slice(0,10));
    }
    const labels = serie.map(p=>p.fecha).concat(future);

    const histData = invHist.concat(Array(future.length).fill(null));
    const projData = Array(serie.length).fill(null).concat(base);
    const projPlusData = Array(serie.length).fill(null).concat(withOrder);

    const kb = Number(data.kb_min||0);
    const sfty = Number(data.inventario_critico||0);

    fillTable(tbody, serie);
    setKPIs(invLast, kb, sfty);
    setSideMetrics(data.min_value||0, data.min_date||'', data.max_value||0, data.max_date||'', data.avg_30||0);

    if (!chartInstance){
      chartInstance = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[
          {label:'Inventario histórico', data:histData, fill:true, pointRadius:0},
          {label:'Proyección 45 días', data:projData, fill:true, pointRadius:0},
          {label:'Proyección + pedido', data:projPlusData, fill:true, pointRadius:0},
          {label:'KB_min (Punto de Reorden)', data:Array(labels.length).fill(kb), pointRadius:0, borderDash:[4,4], fill:false},
          {label:'Inventario Crítico', data:Array(labels.length).fill(sfty), pointRadius:0, borderDash:[4,2], fill:false}
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          animation:false,
          interaction:{ mode:'nearest', intersect:false },
          scales:{
            y:{ beginAtZero:true, title:{display:true, text:'Cantidad'}, ticks:{ callback:(v)=> new Intl.NumberFormat().format(v) } },
            x:{ ticks:{ maxRotation:0, autoSkipPadding:20 } }
          },
          plugins:{
            legend:{ position:'bottom' },
            title:{ display:true, text: (data.subject_label||('Suministro: ' + (termInp.value||''))) },
            tooltip:{ callbacks:{ label:(ctx)=>{
              const v = ctx.parsed.y;
              return `${ctx.dataset.label}: ${Number.isFinite(v)? fmtInt(v) : ''}`;
            }}}
          },
          elements:{ line:{ tension:0.2 } }
        }
      });
    } else {
      chartInstance.data.labels = labels;
      chartInstance.data.datasets[0].data = histData;
      chartInstance.data.datasets[1].data = projData;
      chartInstance.data.datasets[2].data = projPlusData;
      chartInstance.data.datasets[3].data = Array(labels.length).fill(kb);
      chartInstance.data.datasets[4].data = Array(labels.length).fill(sfty);
      chartInstance.options.plugins.title.text = (data.subject_label||('Suministro: ' + (termInp.value||'')));
      chartInstance.update();
    }
  }

  // Listeners
  $('btn').addEventListener('click', run);
  $('refreshBtn').addEventListener('click', run);
  $('btnClear').addEventListener('click', ()=>{
    modeSel.value = 'Suministro';
    fillTerms();
    if (sups.length > 0) termInp.value = sups[0];
    groupSel.value = '';
    $('qty').value = 0;
    from.value = meta.min_fecha || '';
    to.value = meta.max_fecha || '';
    document.querySelector('#tbl tbody').innerHTML='';
    setKPIs(0,0,0);
    setSideMetrics(0,'',0,'',0);
    if (chartInstance){ chartInstance.destroy(); chartInstance=null; }
  });

  // Ejecutar una primera vez con el primer Suministro
  await run();
}

window.addEventListener('load', ()=>{ init(); });

// Register SW if present
if ('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}
</script>
</body>
</html>
