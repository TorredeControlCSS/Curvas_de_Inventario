<!doctype html>
<html lang="es" data-theme="system">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Curvas de Inventario</title>
  <link rel="icon" href="icons/icon-512.png">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    :root{ --bg:#0b1f3a; --bg2:#133a74; --card:#ffffff; --muted:#6b7280; --ring:#e5e7eb;
           --text:#0f172a; --sub:#334155; --border:#e5e7eb; --canvas:#f6f7fb; --vh:1vh; }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0a1120; --bg2:#0f2142; --card:#0f172a; --muted:#94a3b8; --ring:#1f2937;
             --text:#e5e7eb; --sub:#cbd5e1; --border:#334155; --canvas:#0b1220; }
    }
    [data-theme="dark"]{ --bg:#0a1120; --bg2:#0f2142; --card:#0f172a; --muted:#94a3b8; --ring:#1f2937;
                         --text:#e5e7eb; --sub:#cbd5e1; --border:#334155; --canvas:#0b1220; }
    [data-theme="light"]{ --bg:#0b1f3a; --bg2:#133a74; --card:#ffffff; --muted:#6b7280; --ring:#e5e7eb;
                          --text:#0f172a; --sub:#334155; --border:#e5e7eb; --canvas:#f6f7fb; }

    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,sans-serif;margin:0;background:var(--canvas);color:var(--text)}

    /* Topbar base */
    .topbar{
      background:linear-gradient(90deg,var(--bg),var(--bg2)); color:#fff;
      padding:12px 14px; display:flex; align-items:center; gap:12px;
      box-shadow:0 2px 10px rgba(0,0,0,.2); position:sticky; top:0; z-index:10;
      justify-content:space-between; transition:transform .18s ease-in-out;
    }
    .topbar.topbar--hidden{ transform:translateY(-110%); }
    .topbar img{width: clamp(40px, 6vw, 56px); height: clamp(40px, 6vw, 56px); border-radius:12px; flex:0 0 auto;}
    .title{font-size:16px;font-weight:700;letter-spacing:.3px;flex:1 1 auto;min-width:200px;}
    .top-actions{display:flex;gap:8px;align-items:center;flex:0 0 auto;}
    .btn{padding:8px 10px;border:1px solid var(--ring);border-radius:10px;background:#fff;color:#0f172a;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;color:#fff;border-color:rgba(255,255,255,.25)}
    .btn.install{background:#00b894;color:#fff;border-color:#00b894}
    .theme-select{padding:6px 8px;border:1px solid rgba(255,255,255,.25);border-radius:10px;background:transparent;color:#fff; min-width:110px}
    .net{font-size:12px;opacity:.85;margin-left:4px}

    /* Móvil: header en columnas */
    @media (max-width: 720px){
      .topbar{ display:flex !important; flex-direction:column !important; align-items:center !important; justify-content:center !important; gap:8px !important; padding:10px !important; }
      .topbar img{ width: clamp(56px, 18vw, 80px) !important; height: clamp(56px, 18vw, 80px) !important; margin:0 !important; }
      .topbar .title{ display:block !important; text-align:center !important; margin:0 !important; }
      .topbar .top-actions{ width:100% !important; display:grid !important; grid-template-columns:1fr !important; gap:8px !important; justify-items:center !important; }
      .topbar .theme-select, .topbar .btn{ width:100% !important; max-width:360px !important; }
      .net{ display:none !important; }
      .topbar{ position: static !important; box-shadow: none; overflow-anchor: none; }
    }
    .topbar{ border-radius: 0 !important; width: 100% !important; }

    .container{padding:14px;max-width:1400px;margin:0 auto}
    .filters{display:grid;grid-template-columns:120px 1fr 1fr 1fr 140px 140px 130px 120px;gap:8px;align-items:end;margin-bottom:12px}
    @media (max-width:1024px){.filters{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){.filters{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    label{font-size:12px;color:var(--sub)}
    select,input,button{width:100%;padding:8px 10px;border:1px solid var(--ring);border-radius:10px;background:#fff;color:#0f172a}
    [data-theme="dark"] select,[data-theme="dark"] input{background:#0b1324;color:#e5e7eb;border-color:#334155}
    button.primary{background:#0b5fff;color:#fff;border-color:#0b5fff;font-weight:700}

    /* KPIs */
    .kpis{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px;margin-top:8px;margin-bottom:12px; grid-auto-rows:minmax(92px,auto)}
    @media (max-width:1024px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){.kpis{grid-template-columns:1fr}}
    .kpi{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;min-height:92px}
    .kpi .v{font-size:clamp(18px, 5.2vw, 22px); font-weight:800; line-height:1.15; white-space:nowrap}
    .kpi .l{font-size:12px;color:var(--sub)}
    .kpi .muted{display:block;margin-top:4px}

    .row{display:grid;grid-template-columns:2fr 1fr;gap:12px}
    @media (max-width:1024px){.row{grid-template-columns:1fr}}

    /* === ALTURA ESTABLE DEL GRÁFICO (usa --vh) === */
    .chart-wrap{
      height: clamp(280px, calc(var(--vh) * 58), 520px);
      isolation:isolate;
      position:relative;
    }
    @media (min-width:1024px){ .chart-wrap{ height: 420px; } }

    .side{display:grid;gap:10px;align-content:start}
    .metric{display:flex;justify-content:space-between;gap:12px;font-weight:700}
    .metric span:-child{max-width:50%;text-align:right;word-break:break-word}
    .table-wrap{max-height:420px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border-bottom:1px solid var(--ring);padding:8px 10px;text-align:left;white-space:nowrap}
    thead th{position:sticky;top:0;background:var(--card);z-index:1}

    /* Tarjetero de fórmulas */
    .formula-cards{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:8px; margin-top:6px; }
    @media (max-width:720px){ .formula-cards{grid-template-columns:1fr} }
    .formula-card{ border:1px dashed var(--border); border-radius:12px; padding:10px; background:rgba(0,0,0,0.02); }
    [data-theme="dark"] .formula-card{ background:rgba(255,255,255,0.02); }
    .fc-title{font-weight:700; color:var(--sub); margin-bottom:4px}
    .fc-value{font-weight:800; font-size:clamp(16px,4.6vw,20px); margin-bottom:4px}
    .fc-formula{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; color:var(--sub)}
    .muted{color:var(--muted);font-size:12px}
    ul.formula{padding-left:18px}

    .proj-table-wrap{ max-height:260px; overflow:auto; margin-top:8px; }
    .proj-table-wrap table{ width:100%; border-collapse:collapse; font-size:12px; }
    .proj-table-wrap th, .proj-table-wrap td{ border-bottom:1px solid var(--ring); padding:6px 8px; white-space:nowrap; }
    .proj-table-wrap thead th{ position:sticky; top:0; background:var(--card); z-index:1; }
  
    /* --- Feedback del botón "Mostrar" --- */
    button.primary{
      position: relative;
      transition: background-color .18s ease, border-color .18s ease, box-shadow .18s ease;
    }
    
    /* Cargando */
    button.primary.is-loading{
      background:#6b7280;        /* gris */
      border-color:#6b7280;
      color:#fff;
      pointer-events:none;
    }
    button.primary.is-loading::after{
      content:"";
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      width:14px; height:14px; border-radius:50%;
      border:2px solid rgba(255,255,255,.35);
      border-top-color:#fff;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }
    
    /* OK (verde) */
    button.primary.is-ok{
      background:#16a34a;
      border-color:#16a34a;
      color:#fff;
    }
    
    /* Error (rojo) */
    button.primary.is-error{
      background:#dc2626;
      border-color:#dc2626;
      color:#fff;
    }
    
    /* Estado disabled visual consistente */
    button.primary:disabled{
      opacity:.85;
      cursor:not-allowed;
    }
    
  
  /* ---- UX tweaks ---- */
  .row > * { min-width: 0; }
  .chart-wrap{ width:100%; }
  canvas#chart{ display:block; width:100% !important; height:100% !important; }
  .input-clear{ position:relative; }
  .input-clear > input{ padding-right:-65px; }
  
  .input-clear > .clear-btn{
    position: absolute; right: -65px; top: 50%; transform: translateY(-50%);
    border: 0; background:transparent; font-size:18px; line-height: 1;
    cursor: pointer; opacity: .6;
  }
  .input-clear > .clear-btn:hover{ opacity: 1; }

  </style>
</head>
<body>
  <div class="topbar">
    <img src="icons/icon-512.png" alt="Logo">
    <div class="title">Curvas de Inventario — CEDIS PANAMA CSS</div>
    <div class="top-actions">
      <select id="theme" class="theme-select" title="Tema">
        <option value="system">Sistema</option>
        <option value="light">Claro</option>
        <option value="dark">Oscuro</option>
      </select>
      <span id="net" class="net"></span>
      <button id="refreshBtn" class="btn ghost">Actualizar</button>
      <button id="installBtn" class="btn install hidden">Instalar app</button>
    </div>
  </div>

  <div class="container">
    <div class="card filters">
      <div>
        <label>Buscar por</label>
        <select id="mode"><option>Código</option><option selected>Suministro</option><option>Grupo</option></select>
      </div>
      <div id="termWrap">
        <label id="lbl-term">Suministro</label>
        <div class="input-clear"><input id="term" list="termOptions" placeholder="Escribe para buscar..." autocomplete="off"><button id="termClear" type="button" aria-label="Limpiar" class="clear-btn">×</button></div>
        <datalist id="termOptions"></datalist>
      </div>
      <div>
        <label>Grupo</label>
        <select id="group"><option value="">Todos</option></select>
      </div>
      <div><label>Pedido (+45d)</label><input id="qty" type="number" min="0" step="100" value="0" inputmode="numeric" enterkeyhint="done"></div>
      <div><label>Desde</label><input id="from" type="date"></div>
      <div><label>Hasta</label><input id="to" type="date"></div>
      <div><button id="btn" class="primary">Mostrar</button></div>
      <div><button id="btnClear">Limpiar</button></div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="l">% Abastecimiento (4 meses)</div><div class="v" id="kpiCov">–</div></div>
      <div class="kpi"><div class="l">Inventario actual</div><div class="v" id="kpiInv">–</div><span class="muted" id="kpiInvDate">–</span></div>
      <div class="kpi"><div class="l">Punto de Reorden (CTD + SS)</div><div class="v" id="kpiKb">–</div></div>
      <div class="kpi"><div class="l">Inv. Crítico (95%)</div><div class="v" id="kpiCrit">–</div></div>
      <div class="kpi"><div class="l">SMA_15 Inventario (nivel inicial)</div><div class="v" id="kpiI0">–</div></div>
    </div>

    <div class="row">
      <div>
        <div class="card chart-wrap"><canvas id="chart"></canvas></div>

        <div class="card" id="formulas">
          <div class="muted">Fórmulas</div>
          <div class="formula-cards">
            <div class="formula-card">
              <div class="fc-title">Punto de Reorden (ROP = CTD + SS)</div>
              <div class="fc-value" id="fc_rop">–</div>
              <div class="fc-formula" id="f_kb">ROP = μ_D × L + SS = ?</div>
            </div>
            <div class="formula-card">
              <div class="fc-title">SS (Inventario Crítico)</div>
              <div class="fc-value" id="fc_ss">–</div>
              <div class="fc-formula" id="f_sfty">SS = z × σ_D × √L = ?</div>
            </div>
            <div class="formula-card">
              <div class="fc-title">Nivel inicial</div>
              <div class="fc-value" id="fc_i0">–</div>
              <div class="fc-formula" id="f_proj1">I₀ = SMA_15(inventario) = ?</div>
            </div>
            <div class="formula-card">
              <div class="fc-title">Dinámica de proyección</div>
              <div class="fc-formula" id="f_proj2">Î_{t+h} = max(Î_{t+h−1} − d̂_h, 0); d̂ por SES(α=0.3), estacionalidad semanal: ?</div>
              <div class="fc-formula" id="f_order">Si Q>0: I'_{t+L} = Î_{t+L} + Q</div>
            </div>
          </div>

          <br/>
          <div class="muted" id="projTitle">Dinámica de proyección (45 días)</div>
          <div class="proj-table-wrap">
            <table id="projTbl">
              <thead><tr><th>Fecha</th><th>d̂ (consumo)</th><th>Î (sin pedido)</th><th>I′ (con pedido)</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>

          <br/>
          <div class="muted">Definiciones</div>
          <ul class="formula" id="defs">
            <li><b>μ_D</b>: mediana de las tasas de consumo diario (últimos 90 días).</li>
            <li><b>σ_D</b>: 1.4826 × MAD de las tasas de consumo diario.</li>
            <li><b>L</b>: lead time en días (45 por defecto).</li>
            <li><b>z</b>: 95% ⇒ 1.65.</li>
            <li><b>I₀</b>: SMA_15 del inventario.</li>
            <li><b>d̂_h</b>: demanda por SES (α=0.3), con estacionalidad semanal si aplica.</li>
            <li><b>ROP</b>: Punto de Reorden = CTD + SS.</li>
          </ul>
        </div>
      </div>

      <div class="side">
        <div class="card">
          <div class="muted">Indicadores de la serie</div>
          <div class="metric"><span>% Abastecimiento (4 meses)</span><span id="mCoverage">–</span></div>
          <small id="mCoverageNote" class="muted"></small>
          <div class="metric"><span>Mínimo histórico</span><span id="mMin">–</span></div>
          <small id="mMinDate" class="muted"></small>
          <div class="metric"><span>Máximo histórico</span><span id="mMax">–</span></div>
          <small id="mMaxDate" class="muted"></small>
          <div class="metric"><span>Promedio 30 días</span><span id="mAvg30">–</span></div>
          <div class="metric"><span>Stock = 0 (est.)</span><span id="mZero">–</span></div>
          <small id="mZeroDate" class="muted"></small>
        </div>

        <div class="card table-wrap">
          <div class="muted">Tabla diaria</div>
          <table id="tbl"><thead><tr><th>Fecha</th><th>Cantidad</th><th>Δ</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </div>

<script>
// === Config ===
const API_BASE = 'https://script.google.com/macros/s/AKfycbwQ4oSPrSKmpP7tq_7pl7uGac5xR6Qd9x3es3B0ChSZ4gshx_m4rZ-kKCyrVwfTSkoGrw/exec';
const LEAD = 45, TYPEAHEAD_LIMIT = 100, USE_SEASONAL = true;
const EXTRA_AFTER_ORDER = 30; // días extra cuando hay Q>0
const horizon = (Q)=> Number(Q) > 0 ? LEAD + EXTRA_AFTER_ORDER : LEAD;

let chartInstance=null, deferredPrompt=null;
let codes=[], sups=[], groups=[];

const fmtInt = (n)=> Number(n||0).toLocaleString();
const fmtPct = (x)=> (Number.isFinite(x)? (Math.round(x*10)/10).toLocaleString(undefined,{maximumFractionDigits:1})+'%' : '–');
const $ = (id)=> document.getElementById(id);

if (window['chartjs-plugin-annotation']) { Chart.register(window['chartjs-plugin-annotation']); }

function setBtnState(el, state){ el.classList.remove('is-loading','is-ok','is-error'); if(state) el.classList.add(state); }

// Tema
(function(){
  const saved = localStorage.getItem('theme') || 'system';
  document.documentElement.setAttribute('data-theme', saved);
  $('theme').value = saved;
  $('theme').addEventListener('change', e=>{
    const val = e.target.value; localStorage.setItem('theme', val);
    document.documentElement.setAttribute('data-theme', val);
  });
})();

// PWA install
window.addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferredPrompt=e; $('installBtn').classList.remove('hidden'); });
$('installBtn').addEventListener('click', async ()=>{ if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; $('installBtn').classList.add('hidden'); deferredPrompt=null; });
window.addEventListener('appinstalled', ()=> $('installBtn').classList.add('hidden'));

// Red
const setNet = (s)=> $('net').textContent = s || '';
window.addEventListener('online', ()=> setNet(''));
window.addEventListener('offline', ()=> setNet('Sin conexión'));
if (!navigator.onLine) setNet('Sin conexión');

// Fetch robusto
async function fetchRetry(url, opts={}, retries=3, backoff=800){
  try{ const r = await fetch(url, {...opts, cache:'no-store'}); if (!r.ok) throw new Error('HTTP '+r.status); return r; }
  catch(e){ if (retries<=0) throw e; await new Promise(res=>setTimeout(res, backoff)); return fetchRetry(url, opts, retries-1, backoff*1.8); }
}
async function fetchJSON(url){ const r = await fetchRetry(url); return r.json(); }

async function safeFetchList(){
  try{ const data = await fetchJSON(API_BASE + '?list=true&ts=' + Date.now()); localStorage.setItem('metaCache', JSON.stringify({t:Date.now(), data})); return data; }
  catch(e){ const c = localStorage.getItem('metaCache'); if (c){ console.warn('Usando metaCache', e); setNet('Sin conexión (caché)'); return JSON.parse(c).data; } throw e; }
}
async function safeFetchSerie(params){ const p = new URLSearchParams(params); p.set('ts', Date.now()); return fetchJSON(API_BASE + '?' + p.toString()); }

// Typeahead
function fillDatalist(arr, q=''){
  const dl = $('termOptions'); const norm = (q||'').trim().toLowerCase();
  let suggestions=[];
  if (!norm){ suggestions = arr.slice(0, TYPEAHEAD_LIMIT); }
  else{
    const starts = arr.filter(v=> v.toLowerCase().startsWith(norm));
    const contains = arr.filter(v=> !v.toLowerCase().startsWith(norm) && v.toLowerCase().includes(norm));
    suggestions = starts.concat(contains).slice(0, TYPEAHEAD_LIMIT);
  }
  dl.innerHTML = suggestions.map(v => `<option value="${v}"></option>`).join('');
}

// Stats helpers
const mean = (a)=> a.length ? a.reduce((x,y)=>x+Number(y||0),0)/a.length : 0;
function smaLast(arr, k){
  const n=arr.length; if(!n) return 0; const slice = arr.slice(Math.max(0,n-k)).map(Number).filter(Number.isFinite);
  if (!slice.length) return 0; if (slice.length>=3){ const s=[...slice].sort((a,b)=>a-b); s.shift(); s.pop(); return mean(s); } return mean(slice);
}
function seasonalityWeekly(cons, H, lastDateISO){
  const n=cons.length; if(n<14) return null; const lastDate=new Date(lastDateISO), weekdayLast=lastDate.getDay();
  const wkIdx=new Array(n); for(let i=n-1,w=weekdayLast;i>=0;i--,w=(w-1+7)%7) wkIdx[i]=w;
  const sums=Array(7).fill(0), cnt=Array(7).fill(0);
  for(let i=0;i<n;i++){ const w=wkIdx[i]; sums[w]+=Number(cons[i]||0); cnt[w]+=1; }
  const avgW = sums.map((s,i)=> cnt[i]? s/cnt[i]:0); const grand = mean(avgW.filter(v=>v>0)) || 1; const factors = avgW.map(v=> v>0 ? v/grand : 1);
  const startW=(weekdayLast+1)%7, season=new Array(H); for(let h=0;h<H;h++) season[h]=factors[(startW+h)%7]||1; return season;
}
function ses(cons, H, alpha=0.3){ if(!cons.length) return Array(H).fill(0); let s=cons[0]; for(let i=1;i<cons.length;i++) s = alpha*cons[i]+(1-alpha)*s; return Array(H).fill(s); }
function simulate(inv0, dHat, q=0, lead=45){
  const H=dHat.length, base=new Array(H), withOrder=new Array(H);
  for(let h=0;h<H;h++) base[h]= h? Math.max(base[h-1]-dHat[h],0) : Math.max(inv0-dHat[0],0);
  withOrder[0]=Math.max(inv0-dHat[0],0); for(let h=1;h<H;h++) withOrder[h]=Math.max(withOrder[h-1]-dHat[h],0);
  const idx=lead-1; if(idx>=0&&idx<H){ withOrder[idx]+=Number(q||0); for(let h=idx+1;h<H;h++) withOrder[h]=Math.max(withOrder[h-1]-dHat[h],0); }
  return {base, withOrder};
}

// Tablas
function fillTable(tbody, serie){
  tbody.innerHTML='';
  let prev = null;
  for (let i=0;i<serie.length;i++){
    const p = serie[i];
    const inv = Number(p.inventario);
    const delta = (prev===null || !Number.isFinite(prev)) ? '–' : fmtInt(prev - inv);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.fecha}</td><td>${fmtInt(inv)}</td><td>${delta}</td>`;
    tbody.appendChild(tr);
    prev = inv;
  }
  if (!tbody.children.length && serie.length){
    const p = serie[serie.length-1];
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.fecha}</td><td>${fmtInt(Number(p.inventario))}</td><td>–</td>`;
    tbody.appendChild(tr);
  }
}
function fillProjTable(tbody, dates, dHat, base, withOrder, lead, Q){
  tbody.innerHTML='';
  for (let i=0;i<dates.length;i++){
    const note = (i === (lead-1)) ? ' ← llegada pedido (+45)' : '';
    const tr = document.createElement('tr');
    tr.innerHTML =
      `<td>${dates[i]}</td>` +
      `<td>${fmtInt(Math.round(dHat[i]||0))}</td>` +
      `<td>${fmtInt(Math.round(base[i]||0))}</td>` +
      `<td>${fmtInt(Math.round(withOrder[i]||0))}${note}</td>`;
    tbody.appendChild(tr);
  }
}
// KPIs y fórmulas
function setKPIs(invLast, rop, sfty, lastDateISO, I0){
  if ($('kpiInv'))     $('kpiInv').textContent = fmtInt(Math.round(invLast||0));
  if ($('kpiInvDate')) $('kpiInvDate').textContent = lastDateISO ? `al ${lastDateISO}` : '';
  if ($('kpiKb'))      $('kpiKb').textContent = fmtInt(Math.round(rop||0));
  if ($('kpiCrit'))    $('kpiCrit').textContent = fmtInt(Math.round(sfty||0));
  if ($('kpiI0'))      $('kpiI0').textContent = fmtInt(Math.round(I0||0));
}
function setSideMetrics(minV,minD,maxV,maxD,avg30,coveragePct,coverageNote){
  if ($('mCoverage'))     $('mCoverage').textContent = fmtPct(coveragePct||0);
  if ($('mCoverageNote')) $('mCoverageNote').textContent = coverageNote || '';
  if ($('mMin'))          $('mMin').textContent = fmtInt(Math.round(minV||0));
  if ($('mMinDate'))      $('mMinDate').textContent = minD ? `en ${minD}` : '';
  if ($('mMax'))          $('mMax').textContent = fmtInt(Math.round(maxV||0));
  if ($('mMaxDate'))      $('mMaxDate').textContent = maxD ? `en ${maxD}` : '';
  if ($('mAvg30'))        $('mAvg30').textContent = fmtInt(Math.round(avg30||0));
}
function setFormulas(mu, sigma, kb, sfty, I0, rop, H){
  if ($('fc_rop')) $('fc_rop').textContent = fmtInt(Math.round(rop||0));
  if ($('f_kb'))   $('f_kb').textContent   = `ROP = μ_D × L + SS = ${fmtInt(Math.round(kb||0))} + ${fmtInt(Math.round(sfty||0))} = ${fmtInt(Math.round(rop||0))}`;
  if ($('fc_ss'))  $('fc_ss').textContent  = fmtInt(Math.round(sfty||0));
  if ($('f_sfty')) $('f_sfty').textContent = `SS = z × σ_D × √L = 1.65 × ${fmtInt(Math.round(Number(sigma||0)))} × √${LEAD} = ${fmtInt(Math.round(sfty||0))}`;
  if ($('fc_i0'))  $('fc_i0').textContent  = fmtInt(Math.round(I0||0));
  if ($('f_proj1')) $('f_proj1').textContent = `I_{t+h} = max(I_{t+h-1} − d̂_h, 0), h=1..${H}; d̂ por SES(α=0.3), estacionalidad semanal: ${USE_SEASONAL ? 'activa' : 'inactiva'}`;
  if ($('f_proj2')) $('f_proj2').textContent = `Si Q>0: I'_{t+h} = I'_{t+h} + Q`;
  if ($('f_order')) $('f_order').textContent = `Llegada pedido (+${LEAD})`;
}

function coverageFourMonths(invLast, serie, mu_d){
  const n = serie.length;
  const rates = [];
  for(let i=1;i<n;i++){
    const prev = Number(serie[i-1].inventario||0);
    const cur  = Number(serie[i].inventario||0);
    const days = (new Date(serie[i].fecha) - new Date(serie[i-1].fecha)) / 86400000 || 1;
    const invDec = Math.max(prev - cur, 0);
    const rate = invDec / days;
    if (Number.isFinite(rate)) rates.push(rate);
  }
  let dailyExpected;
  if (rates.length >= 8){
    const recent = rates.slice(-56); // ~8 semanas
    dailyExpected = recent.reduce((a,b)=>a+b,0)/(recent.length||1);
  } else {
    dailyExpected = Number(mu_d||0);
  }
  const weeklyExpected = dailyExpected * 7;
  const needFor4M = weeklyExpected * 4 * 4.345; // ~4 meses
  const pct = needFor4M ? Math.min((invLast/needFor4M)*100, 999) : 0;
  const note = `Consumo semanal esperado ≈ ${fmtInt(Math.round(weeklyExpected))}. Requerido 4 meses ≈ ${fmtInt(Math.round(needFor4M))}.`;
  return { pct, note };
}

// === INIT ===
async function init(){
  const modeSel=$('mode'), termInp=$('term'), lbl=$('lbl-term'), termWrap=$('termWrap'),
        groupSel=$('group'), qty=$('qty'), from=$('from'), to=$('to'),
        btn=$('btn'), btnClear=$('btnClear'), refreshBtn=$('refreshBtn'),
        tbody=document.querySelector('#tbl tbody'),
        projTbody=document.querySelector('#projTbl tbody');

  const meta = await safeFetchList();
  codes = meta.codigos||[]; sups = meta.suministros||[]; groups=[''].concat(meta.grupos||[]);
  $('group').innerHTML = groups.map(g => `<option value="${g}">${g||'Todos'}</option>`).join('');
  from.value = meta.min_fecha||''; to.value = meta.max_fecha||'';

  function fillTerms(){
    const mode=modeSel.value;
    if(mode==='Código'){ lbl.textContent='Código'; termWrap.classList.remove('hidden'); termInp.value=''; fillDatalist(codes); }
    else if(mode==='Suministro'){ lbl.textContent='Suministro'; termWrap.classList.remove('hidden'); termInp.value=''; fillDatalist(sups); }
    else { termWrap.classList.add('hidden'); termInp.value=''; }
  }
  modeSel.addEventListener('change', fillTerms);
  termInp.addEventListener('input', e=>{ const arr = (modeSel.value==='Código')? codes : sups; fillDatalist(arr, e.target.value||''); });

  // Por defecto: Suministro + primer valor
  modeSel.value='Suministro'; fillTerms(); if (sups.length>0) termInp.value = sups[0];

  
  // Botón limpiar término
  const termClearBtn = $('termClear');
  if (termClearBtn){ termClearBtn.addEventListener('click', ()=>{ termInp.value=''; termInp.focus(); fillDatalist([], ''); }); }
  // Ocultar teclado numérico al confirmar
  qty.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); qty.blur(); } });
  qty.addEventListener('change', ()=>{ qty.blur(); });
  // Enter en término ejecuta búsqueda y también al elegir del datalist
  termInp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); termInp.blur(); run(); } });
  termInp.addEventListener('change', ()=>{ if(termInp.value && termInp.value.trim().length>0){ run(); } });
async function run(){
    setBtnState(btn,'is-loading'); btn.disabled = true;
    try{
      const mode=modeSel.value, group=groupSel.value, Q=Number(qty.value||0);
      const H = horizon(Q);
      const params={}; const fromV=from.value, toV=to.value;
      if(mode==='Código') params.codigo=termInp.value;
      if(mode==='Suministro') params.suministro=termInp.value;
      if(group && mode!=='Grupo') params.grupo=group;
      if(mode==='Grupo') params.grupo=group;
      if(fromV) params.from=fromV; if(toV) params.to=toV;

      const data = await safeFetchSerie(params);
      let serie = data.serie||[];
      // --- Normalización de la serie (garantiza último punto, orden y unicidad por fecha) ---
      serie = (serie||[])
        .filter(p => p && p.fecha && Number.isFinite(Number(p.inventario)))
        .sort((a,b) => a.fecha.localeCompare(b.fecha));
      
      // si vienen varias filas por la misma fecha, nos quedamos con la última
      const byDate = new Map();
      for (const p of serie) byDate.set(p.fecha, p);
      serie = Array.from(byDate.values()).sort((a,b)=> a.fecha.localeCompare(b.fecha));
      
      if(!serie.length){ alert('Sin datos para esa selección/filtro.'); setBtnState(btn,'is-error'); setTimeout(()=>{ setBtnState(btn,''); btn.disabled=false; }, 900); return; }

      
const invHist = serie.map(p => Number(p.inventario));
const lastVal = invHist[invHist.length - 1];
// === SMA_15 para KPI ===
const SMA_WINDOW = 15;
const tail = invHist.slice(-SMA_WINDOW).filter(Number.isFinite);
const sma15 = tail.length
  ? tail.reduce((a,b)=> a+b, 0) / tail.length
  : lastVal

// Consumo por día evitando sesgo por stockout (solo si prev ≥ 0.8 × SS)
const cons = [];
const ss = Number(data.inventario_critico||0);
for (let i=1;i<invHist.length;i++){
  const prev = invHist[i-1], cur = invHist[i];
  const delta = Math.max(prev - cur, 0);
  const enoughStock = prev >= ss * 0.8;
  cons.push(enoughStock ? delta : NaN);
}

// Ventana reciente fija: 8 semanas (56 días)
const WIN_DAYS = 56;
const consWin = cons.slice(-WIN_DAYS).map(Number).filter(Number.isFinite);

// Suavizado exponencial simple (α=0.3) sobre la ventana
function sesWindow(cons, H, alpha = 0.3) {
  if (!cons.length) return Array(H).fill(0);
  let s = cons[0];
  for (let i=1; i<cons.length; i++) s = alpha*cons[i] + (1-alpha)*s;
  return Array(H).fill(s);
}
let dHat = sesWindow(consWin, H, 0.3);

// Estacionalidad semanal sobre la misma ventana
function seasonalityWeeklyWin(cons, H, lastDateISO){
  const n = cons.length; if (n < 14) return null;
  const lastDate = new Date(lastDateISO), weekdayLast = lastDate.getDay();
  const wkIdx = new Array(n); for (let i=n-1,w=weekdayLast;i>=0;i--,w=(w-1+7)%7) wkIdx[i]=w;
  const sums = Array(7).fill(0), cnt = Array(7).fill(0);
  for (let i=0;i<n;i++){ const w=wkIdx[i]; sums[w]+=Number(cons[i]||0); cnt[w]+=1; }
  const avgW = sums.map((s,i)=> cnt[i]? s/cnt[i]:0);
  const grand = avgW.reduce((a,b)=>a+b,0) / (avgW.filter(v=>v>0).length || 1);
  if (!Number.isFinite(grand) || grand <= 0) return null;
  const factors = avgW.map(v=> v>0 ? v/grand : 1);
  const startW = (weekdayLast+1)%7, season = new Array(H);
  for (let h=0; h<H; h++) season[h] = factors[(startW+h)%7] || 1;
  return season;
}
if (USE_SEASONAL){
  const seas = seasonalityWeeklyWin(consWin, H, lastDateStr);
  if (seas) dHat = dHat.map((v,i)=> Math.max(v * seas[i], 0));
}

// Piso mínimo con mu_d para no colapsar a 0 cuando hubo stockout prolongado
const muDaily = Number(data.mu_d||0);
const MIN_FACTOR = 0.6; // 60% del promedio diario backend
if (muDaily > 0) dHat = dHat.map(v => Math.max(v, muDaily * MIN_FACTOR));

// Proyección arranca en el último inventario real
const I0 = lastVal;
const { base, withOrder } = simulate(I0, dHat, Q, data.lead || LEAD);


// Fechas futuras y datasets
const lastDate = new Date(lastDateStr), future = [];
for (let i=1; i<=H; i++){ const d = new Date(lastDate); d.setDate(d.getDate()+i); future.push(d.toISOString().slice(0,10)); }
const labels = serie.map(p=>p.fecha).concat(future);

const histData     = invHist.concat(Array(future.length).fill(null));
const projData     = Array(serie.length).fill(null).concat(base);
const projPlusData = Array(serie.length).fill(null).concat(withOrder);

// === ETA de stock = 0 usando SOLO la proyección visible (coherente con la gráfica) ===
let zeroDateStr = '';
if (base && base.length) {
  const idxZero = base.findIndex(v => Number(v || 0) <= 0);
  if (idxZero >= 0) zeroDateStr = future[idxZero] || '';
}
if (document.getElementById('mZero')) document.getElementById('mZero').textContent = zeroDateStr ? zeroDateStr : 'No llega a 0 en horizonte';
if (document.getElementById('mZeroDate')) document.getElementById('mZeroDate').textContent = zeroDateStr
  ? 'Fecha estimada en que el stock llegaría a 0.'
  : 'No alcanza 0 dentro del horizonte mostrado.';


      const kb = Number(data.kb_min||0);               // μ_D × L
      const sfty = Number(data.inventario_critico||0); // SS
      const rop = kb + sfty;                            // ROP

      fillTable(tbody, serie);
      setKPIs(lastVal, rop, sfty, lastDateStr, sma15);

      // Cobertura 4 meses consistente con la proyección (usa d̂)
      const dailyExpected = dHat.length
        ? dHat.reduce((a,b)=>a + Number(b||0), 0) / dHat.length
        : Number(data.mu_d||0);
      
      const weeklyExpected = dailyExpected * 7;
      const needFor4M = weeklyExpected * 4 * 4.345; // ~4 meses
      const covPct = needFor4M ? Math.min((lastVal / needFor4M) * 100, 999) : 0;
      const covNote = `Consumo semanal esperado ≈ ${fmtInt(Math.round(weeklyExpected))}. Requerido 4 meses ≈ ${fmtInt(Math.round(needFor4M))}.`;
      
      $('kpiCov').textContent = fmtPct(covPct);
      setSideMetrics(data.min_value||0, data.min_date||'', data.max_value||0, data.max_date||'', data.avg_30||0, covPct, covNote);

      setFormulas(data.mu_d||0, data.sigma_d||0, kb, sfty, sma15, rop, H);
      fillProjTable(projTbody, future, dHat, base, withOrder, data.lead||LEAD, Q);

      let graphTitle = '';
      if (data.subject_code && data.subject_name) graphTitle = `${data.subject_code} — ${data.subject_name}`;
      else if (data.subject_code) graphTitle = `Código: ${data.subject_code}`;
      else graphTitle = data.subject_label || 'Serie seleccionada';

      $('projTitle').textContent = `Dinámica de proyección (${H} días)`;

      const ctx = document.getElementById('chart').getContext('2d');
      const arrivalLabel = future[Math.min((data.lead||LEAD)-1, future.length-1)];

      if(!chartInstance){
        chartInstance = new Chart(ctx, {
          type:'line',
          data:{ labels, datasets:[
            {label:'Inventario histórico', data:histData, fill:true, pointRadius:0},
            {label:`Proyección ${H} días`, data:projData, fill:true, pointRadius:0},
            {label:'Proyección + pedido', data:projPlusData, fill:true, pointRadius:0},
            {label:'Punto de Reorden (CTD+SS)', data:Array(labels.length).fill(rop), pointRadius:0, borderDash:[4,4], fill:false},
            {label:'Inventario Crítico', data:Array(labels.length).fill(sfty), pointRadius:0, borderDash:[4,2], fill:false}
          ]},
          options:{
            responsive:true, maintainAspectRatio:false, animation:false,
            interaction:{mode:'nearest',intersect:false},
            scales:{ y:{beginAtZero:true,title:{display:true,text:'Cantidad'},ticks:{callback:v=>new Intl.NumberFormat().format(v)}}, x:{ticks:{maxRotation:0,autoSkipPadding:20}} },
            plugins:{
              legend:{position:'bottom'},
              title:{display:true, text:graphTitle},
              tooltip:{callbacks:{label:(ctx)=>{ const v=ctx.parsed.y; return `${ctx.dataset.label}: ${Number.isFinite(v)? fmtInt(v):''}`; }}},
              annotation: { annotations: { arrival: { type:'line', xMin:arrivalLabel, xMax:arrivalLabel, borderColor:'rgba(160,160,160,0.8)', borderWidth:1, borderDash:[6,4], label:{ display:true, content:'Llegada pedido (t+45)', position:'start', backgroundColor:'rgba(0,0,0,0.0)', color:'#666', rotation:-90, xAdjust:-6, yAdjust:12 } } } }
            },
            elements:{ line:{tension:0.2} }
          }
        });
        window.chartInstance = chartInstance;
        requestAnimationFrame(fixAfterRotate);
      }else{
        chartInstance.data.labels=labels;
        chartInstance.data.datasets[0].data=histData;
        chartInstance.data.datasets[1].label=`Proyección ${H} días`;
        chartInstance.data.datasets[1].data=projData;
        chartInstance.data.datasets[2].data=projPlusData;
        chartInstance.data.datasets[3].data=Array(labels.length).fill(rop);
        chartInstance.data.datasets[4].data=Array(labels.length).fill(sfty);
        chartInstance.options.plugins.title.text=graphTitle;
        if (chartInstance.options.plugins.annotation) {
          chartInstance.options.plugins.annotation.annotations.arrival.xMin = arrivalLabel;
          chartInstance.options.plugins.annotation.annotations.arrival.xMax = arrivalLabel;
        }
        chartInstance.update();
        window.chartInstance = chartInstance;
        requestAnimationFrame(fixAfterRotate);
      }

      setBtnState(btn,'is-ok'); setTimeout(()=>{ setBtnState(btn,''); btn.disabled=false; }, 900);

    }catch(e){
      console.error(e);
      setBtnState(btn,'is-error'); setTimeout(()=>{ setBtnState(btn,''); btn.disabled=false; }, 1200);
    }
  }

  $('btn').addEventListener('click', run);
  $('refreshBtn').addEventListener('click', run);
  $('btnClear').addEventListener('click', ()=>{
    modeSel.value='Suministro'; fillTerms(); if(sups.length>0) termInp.value=sups[0];
    groupSel.value=''; $('qty').value=0; from.value=meta.min_fecha||''; to.value=meta.max_fecha||'';
    document.querySelector('#tbl tbody').innerHTML=''; document.querySelector('#projTbl tbody').innerHTML='';
    setKPIs(0,0,0,'',0); $('kpiCov').textContent='–'; setSideMetrics(0,'',0,'',0,0,''); setFormulas(0,0,0,0,0,0,LEAD);
    if(chartInstance){ chartInstance.destroy(); chartInstance=null; }
    setBtnState(btn,''); btn.disabled=false; $('projTitle').textContent = 'Dinámica de proyección (45 días)';
  });

  await run();
}

// Header móvil: ocultar/mostrar en scroll
(function(){
  const tb = document.querySelector('.topbar'); if (!tb) return; let lastY = window.scrollY, hidden = false;
  function onScroll(){ const y = window.scrollY; const isMobile = window.innerWidth <= 720; if (!isMobile){ if (hidden){ tb.classList.remove('topbar--hidden'); hidden=false; } lastY = y; return; } if (y > lastY + 12 && y > 60 && !hidden){ tb.classList.add('topbar--hidden'); hidden = true; } else if (y < lastY - 12 && hidden){ tb.classList.remove('topbar--hidden'); hidden = false; } lastY = y; }
  window.addEventListener('scroll', onScroll, {passive:true});
  window.addEventListener('resize', ()=>{ tb.classList.remove('topbar--hidden'); hidden=false; lastY=window.scrollY; });
})();

window.addEventListener('load', init);
if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js').catch(()=>{}); }

function normalizeHeader(){ const tb = document.querySelector('.topbar'); if (!tb) return; if (window.innerWidth <= 720){ tb.classList.remove('topbar--hidden'); tb.style.position = 'static'; tb.style.transform = 'none'; } }
(function(){ const BTN = document.getElementById('btn'); const REF = document.getElementById('refreshBtn'); const _safe = (fn)=> fn && fn.addEventListener && fn.addEventListener('click', ()=> setTimeout(normalizeHeader, 0)); _safe(BTN); _safe(REF); window.addEventListener('load', ()=> setTimeout(normalizeHeader, 0)); })();

// === FIX MÓVIL: actualiza --vh y fuerza resize del chart ===
function setVH(){
  const vh = (window.visualViewport?.height || window.innerHeight) * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
function fixAfterRotate(){
  setVH();
  const c = window.chartInstance || chartInstance;
  if (c && typeof c.resize === 'function'){ try{ c.resize(); }catch(_){} }
}
setVH();
window.addEventListener('orientationchange', ()=> setTimeout(fixAfterRotate, 350));
window.addEventListener('resize',             ()=> setTimeout(fixAfterRotate, 150));
if (window.visualViewport){ window.visualViewport.addEventListener('resize', ()=> setTimeout(fixAfterRotate, 150)); }

// Observa el contenedor por cambios reales de tamaño
window.addEventListener('load', ()=>{
  const wrap = document.querySelector('.chart-wrap');
  if (!wrap || !('ResizeObserver' in window)) return;
  const ro = new ResizeObserver(()=>{ const c = window.chartInstance || chartInstance; if (c && typeof c.resize === 'function') c.resize(); });
  ro.observe(wrap);
});
</script>
</body>
</html>
